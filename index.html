<div key={category} className="mb-6">
                            <h4 className="text-md font-semibold text-green-600 mb-3">
                              {category}
                            </h4>
                            <div className="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-8 gap-3 pl-4">
                              {earnedInCategory.map(badge => (
                                <div
                                  key={badge.id}
                                  className="text-center p-3 rounded-lg bg-yellow-50 border-2 border-yellow-400 relative cursor-pointer hover:shadow-lg transition group"
                                  onClick={() => setSelectedBadge(badge)}
                                >
                                  <div className="text-3xl mb-1">{badge.icon}</div>
                                  <div className="font-semibold text-xs leading-tight break-words overflow-hidden" style={{minHeight: '2.5rem'}}>{badge.name}</div>
                                  {badge.count > 0 && badge.type !== 'count' && (
                                    <div className="absolute -top-2 -right-2 bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">
                                      {badge.count}
                                    </div>
                                  )}
                                  <div className="absolute top-1 right-1 bg-green-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">
                                    ?<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hike Together</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Modal component for badge info
        const BadgeModal = ({ badge, onClose }) => {
          if (!badge) return null;
          
          return (
            <div 
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
              onClick={onClose}
            >
              <div 
                className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl"
                onClick={(e) => e.stopPropagation()}
              >
                <div className="text-center">
                  <div className="text-6xl mb-4">{badge.icon}</div>
                  <h3 className="text-2xl font-bold text-green-800 mb-2">{badge.name}</h3>
                  <p className="text-gray-600 mb-4">{badge.desc}</p>
                  {badge.requirement && (
                    <div className="bg-green-50 rounded-lg p-3 mb-4">
                      <p className="text-sm font-semibold text-green-800">
                        Requirement: {badge.requirement} {badge.type === 'count' ? 'hikes' : badge.type === 'distance' ? 'miles' : 'feet'}
                      </p>
                    </div>
                  )}
                  {badge.earned && badge.count > 0 && (
                    <div className="bg-yellow-50 rounded-lg p-3 mb-4">
                      <p className="text-sm font-semibold text-yellow-800">
                        ‚ú® Achieved {badge.count} time{badge.count !== 1 ? 's' : ''}!
                      </p>
                    </div>
                  )}
                  <button
                    onClick={onClose}
                    className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // Lucide React icons as inline SVG components
        const Mountain = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m8 3 4 8 5-5 5 15H2L8 3z"/>
            </svg>
        );

        const Award = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="8" r="6"/>
                <path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/>
            </svg>
        );

        const TrendingUp = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/>
                <polyline points="16 7 22 7 22 13"/>
            </svg>
        );

        const Plus = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M5 12h14"/>
                <path d="M12 5v14"/>
            </svg>
        );

        const Calendar = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                <line x1="16" x2="16" y1="2" y2="6"/>
                <line x1="8" x2="8" y1="2" y2="6"/>
                <line x1="3" x2="21" y1="10" y2="10"/>
            </svg>
        );

        const MapPin = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg>
        );

        const BADGES = [
          // Milestone Badges
          { id: 'first', name: 'First Steps', icon: 'ü•æ', type: 'count', requirement: 1, desc: 'Complete your first hike' },
          { id: 'explorer', name: 'Explorer', icon: 'üó∫Ô∏è', type: 'count', requirement: 5, desc: 'Complete 5 hikes' },
          { id: 'adventurer', name: 'Adventurer', icon: '‚õ∞Ô∏è', type: 'count', requirement: 10, desc: 'Complete 10 hikes' },
          { id: 'trailblazer', name: 'Trailblazer', icon: 'üî•', type: 'count', requirement: 25, desc: 'Complete 25 hikes' },
          { id: 'legend', name: 'Hiking Legend', icon: 'üëë', type: 'count', requirement: 50, desc: 'Complete 50 hikes' },
          { id: 'century', name: 'Century Club', icon: 'üíØ', type: 'count', requirement: 100, desc: 'Complete 100 hikes' },
          
          // Distance Badges
          { id: 'distance10', name: 'First 10', icon: 'üèÉ', type: 'distance', requirement: 10, desc: 'Hike 10 total miles' },
          { id: 'distance25', name: 'Quarter Century', icon: 'üö∂', type: 'distance', requirement: 25, desc: 'Hike 25 total miles' },
          { id: 'distance50', name: 'Half Century', icon: 'ü•á', type: 'distance', requirement: 50, desc: 'Hike 50 total miles' },
          { id: 'distance100', name: 'Centurion', icon: '‚≠ê', type: 'distance', requirement: 100, desc: 'Hike 100 total miles' },
          { id: 'distance250', name: 'Ultra Hiker', icon: 'üí™', type: 'distance', requirement: 250, desc: 'Hike 250 total miles' },
          { id: 'distance500', name: 'Marathon Master', icon: 'üèÜ', type: 'distance', requirement: 500, desc: 'Hike 500 total miles' },
          
          // Elevation Badges
          { id: 'climber1k', name: 'Hill Climber', icon: 'üßó', type: 'elevation', requirement: 1000, desc: 'Climb 1,000 feet total' },
          { id: 'climber5k', name: 'Peak Climber', icon: 'üèîÔ∏è', type: 'elevation', requirement: 5000, desc: 'Climb 5,000 feet total' },
          { id: 'climber10k', name: 'Mountain Goat', icon: 'üêê', type: 'elevation', requirement: 10000, desc: 'Climb 10,000 feet total' },
          { id: 'climber25k', name: 'Everest Base', icon: 'üóª', type: 'elevation', requirement: 25000, desc: 'Climb 25,000 feet total' },
          { id: 'climber50k', name: 'Sky Walker', icon: '‚òÅÔ∏è', type: 'elevation', requirement: 50000, desc: 'Climb 50,000 feet total' },
          { id: 'climber100k', name: 'Altitude King', icon: 'üëë', type: 'elevation', requirement: 100000, desc: 'Climb 100,000 feet total' },
          
          // Nature Discovery Badges (Repeatable)
          { id: 'waterfall', name: 'Waterfall Finder', icon: 'üí¶', type: 'discovery', desc: 'Find a waterfall' },
          { id: 'wildlife', name: 'Wildlife Spotter', icon: 'ü¶å', type: 'discovery', desc: 'See a wild animal' },
          { id: 'bird', name: 'Bird Watcher', icon: 'ü¶Ö', type: 'discovery', desc: 'Spot a bird' },
          { id: 'butterfly', name: 'Butterfly Hunter', icon: 'ü¶ã', type: 'discovery', desc: 'See a butterfly' },
          { id: 'mushroom', name: 'Fungi Finder', icon: 'üçÑ', type: 'discovery', desc: 'Discover mushrooms' },
          { id: 'wildflower', name: 'Flower Power', icon: 'üå∏', type: 'discovery', desc: 'Find wildflowers' },
          { id: 'treeclimb', name: 'Tree Hugger', icon: 'üå≥', type: 'discovery', desc: 'Hug a big tree' },
          { id: 'pinecone', name: 'Pine Collector', icon: 'üå≤', type: 'discovery', desc: 'Collect a pinecone' },
          { id: 'rock', name: 'Rock Hound', icon: 'ü™®', type: 'discovery', desc: 'Find a cool rock' },
          { id: 'feather', name: 'Feather Finder', icon: 'ü™∂', type: 'discovery', desc: 'Find a feather' },
          { id: 'stream', name: 'Stream Crosser', icon: 'üåä', type: 'discovery', desc: 'Cross a stream' },
          { id: 'cave', name: 'Cave Explorer', icon: 'üï≥Ô∏è', type: 'discovery', desc: 'Explore a cave' },
          { id: 'bridge', name: 'Bridge Walker', icon: 'üåâ', type: 'discovery', desc: 'Cross a bridge' },
          { id: 'sunset', name: 'Sunset Chaser', icon: 'üåÖ', type: 'discovery', desc: 'Watch a sunset' },
          { id: 'sunrise', name: 'Early Bird', icon: 'üåÑ', type: 'discovery', desc: 'Watch a sunrise' },
          { id: 'rainbow', name: 'Rainbow Finder', icon: 'üåà', type: 'discovery', desc: 'See a rainbow' },
          { id: 'fog', name: 'Mist Walker', icon: 'üå´Ô∏è', type: 'discovery', desc: 'Hike in fog' },
          { id: 'snow', name: 'Snow Trekker', icon: '‚ùÑÔ∏è', type: 'discovery', desc: 'Hike in snow' },
          { id: 'rain', name: 'Rain Ranger', icon: 'üåßÔ∏è', type: 'discovery', desc: 'Hike in rain' },
          { id: 'frog', name: 'Frog Friend', icon: 'üê∏', type: 'discovery', desc: 'See a frog or toad' },
          { id: 'squirrel', name: 'Squirrel Scout', icon: 'üêøÔ∏è', type: 'discovery', desc: 'Spot a squirrel' },
          { id: 'snake', name: 'Snake Spotter', icon: 'üêç', type: 'discovery', desc: 'See a snake safely' },
          { id: 'turtle', name: 'Turtle Tracker', icon: 'üê¢', type: 'discovery', desc: 'Find a turtle' },
          { id: 'rabbit', name: 'Bunny Buddy', icon: 'üê∞', type: 'discovery', desc: 'Spot a rabbit' },
          { id: 'fish', name: 'Fish Finder', icon: 'üêü', type: 'discovery', desc: 'See fish in water' },
          { id: 'acorn', name: 'Acorn Collector', icon: 'üå∞', type: 'discovery', desc: 'Collect an acorn' },
          { id: 'leaf', name: 'Leaf Lover', icon: 'üçÇ', type: 'discovery', desc: 'Find a pretty leaf' },
          { id: 'stick', name: 'Walking Stick', icon: 'ü¶Ø', type: 'discovery', desc: 'Find a hiking stick' },
          { id: 'bee', name: 'Bee Keeper', icon: 'üêù', type: 'discovery', desc: 'See a bee or wasp' },
          { id: 'spider', name: 'Spider Scout', icon: 'üï∑Ô∏è', type: 'discovery', desc: 'Find a spider web' },
          { id: 'tracks', name: 'Track Finder', icon: 'üêæ', type: 'discovery', desc: 'Find animal tracks' },
          { id: 'berries', name: 'Berry Scout', icon: 'ü´ê', type: 'discovery', desc: 'Find wild berries' },
          { id: 'nest', name: 'Nest Finder', icon: 'ü™π', type: 'discovery', desc: 'Find a bird nest' },
          { id: 'fossil', name: 'Time Detective', icon: 'ü¶¥', type: 'discovery', desc: 'Find a fossil' },
          { id: 'crystal', name: 'Crystal Hunter', icon: 'üíé', type: 'discovery', desc: 'Find crystals' },
          { id: 'clouds', name: 'Cloud Watcher', icon: '‚òÅÔ∏è', type: 'discovery', desc: 'Watch the clouds' },
          { id: 'wind', name: 'Wind Rider', icon: 'üí®', type: 'discovery', desc: 'Hike in strong wind' },
          { id: 'moon', name: 'Moon Gazer', icon: 'üåô', type: 'discovery', desc: 'See the moon' },
          
          // Location Type Badges
          { id: 'beach', name: 'Beach Comber', icon: 'üèñÔ∏è', type: 'location', desc: 'Hike at the beach' },
          { id: 'desert', name: 'Desert Wanderer', icon: 'üèúÔ∏è', type: 'location', desc: 'Hike in the desert' },
          { id: 'forest', name: 'Forest Friend', icon: 'üå≤', type: 'location', desc: 'Hike in a forest' },
          { id: 'mountain', name: 'Mountain Master', icon: '‚õ∞Ô∏è', type: 'location', desc: 'Hike in mountains' },
          { id: 'canyon', name: 'Canyon Explorer', icon: 'üèûÔ∏è', type: 'location', desc: 'Hike in a canyon' },
          { id: 'lake', name: 'Lake Lover', icon: 'üèûÔ∏è', type: 'location', desc: 'Hike around a lake' },
          { id: 'river', name: 'River Runner', icon: 'üèûÔ∏è', type: 'location', desc: 'Hike along a river' },
          { id: 'statepark', name: 'Park Visitor', icon: 'üèïÔ∏è', type: 'location', desc: 'Visit a state park' },
          { id: 'nationalpark', name: 'Park Ranger', icon: 'üéñÔ∏è', type: 'location', desc: 'Visit a national park' },
          { id: 'meadow', name: 'Meadow Walker', icon: 'üåæ', type: 'location', desc: 'Hike through a meadow' },
          { id: 'wetland', name: 'Wetland Explorer', icon: 'ü¶Ü', type: 'location', desc: 'Visit a wetland or marsh' },
          { id: 'jungle', name: 'Jungle Trekker', icon: 'üå¥', type: 'location', desc: 'Hike in a jungle' },
          { id: 'prairie', name: 'Prairie Walker', icon: 'üåª', type: 'location', desc: 'Hike on the prairie' },
          { id: 'tundra', name: 'Tundra Explorer', icon: 'üßä', type: 'location', desc: 'Hike in tundra' },
          { id: 'volcano', name: 'Volcano Adventurer', icon: 'üåã', type: 'location', desc: 'Hike near a volcano' },
          
          // Special Achievement Badges
          { id: 'family', name: 'Family Time', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', type: 'special', desc: 'Whole family hikes together' },
          { id: 'picnic', name: 'Trail Feast', icon: 'üß∫', type: 'special', desc: 'Have a trail picnic' },
          { id: 'camping', name: 'Happy Camper', icon: '‚õ∫', type: 'special', desc: 'Camp overnight' },
          { id: 'stargazing', name: 'Star Gazer', icon: '‚≠ê', type: 'special', desc: 'Stargaze on trail' },
          { id: 'geocache', name: 'Treasure Hunter', icon: 'üíé', type: 'special', desc: 'Find a geocache' },
          { id: 'summit', name: 'Summit Seeker', icon: 'üéØ', type: 'special', desc: 'Reach a summit' },
          { id: 'lighthouse', name: 'Light Keeper', icon: 'üóº', type: 'special', desc: 'Visit a lighthouse' },
          { id: 'historic', name: 'Time Traveler', icon: 'üèõÔ∏è', type: 'special', desc: 'Visit historic site' },
          { id: 'photog', name: 'Photo Pro', icon: 'üì∏', type: 'special', desc: 'Take amazing photos' },
          { id: 'notrail', name: 'Off the Beaten Path', icon: 'üß≠', type: 'special', desc: 'Hike off-trail' },
          { id: 'leader', name: 'Trail Leader', icon: 'üßë‚Äçüè´', type: 'special', desc: 'Lead the group' },
          { id: 'map', name: 'Navigator', icon: 'üó∫Ô∏è', type: 'special', desc: 'Use a map or compass' },
          { id: 'journal', name: 'Nature Writer', icon: 'üìì', type: 'special', desc: 'Write in nature journal' },
          { id: 'art', name: 'Trail Artist', icon: 'üé®', type: 'special', desc: 'Draw or paint on trail' },
          { id: 'song', name: 'Trail Singer', icon: 'üéµ', type: 'special', desc: 'Sing hiking songs' },
          { id: 'story', name: 'Story Teller', icon: 'üìö', type: 'special', desc: 'Tell stories on trail' },
          { id: 'game', name: 'Trail Games', icon: 'üé≤', type: 'special', desc: 'Play trail games' },
          { id: 'clean', name: 'Trail Keeper', icon: '‚ôªÔ∏è', type: 'special', desc: 'Pick up litter' },
          { id: 'help', name: 'Helpful Hiker', icon: 'ü§ù', type: 'special', desc: 'Help another hiker' },
          { id: 'courage', name: 'Brave Heart', icon: 'üí™', type: 'special', desc: 'Overcome a fear' },
          { id: 'early', name: 'Morning Glory', icon: 'üåû', type: 'special', desc: 'Start before 7am' },
          { id: 'long', name: 'Endurance Pro', icon: '‚è±Ô∏è', type: 'special', desc: 'Hike 4+ hours' },
          { id: 'quiet', name: 'Silent Steps', icon: 'ü§´', type: 'special', desc: 'Hike in silence' },
          { id: 'backwards', name: 'Backwards Walker', icon: 'üîÑ', type: 'special', desc: 'Walk backwards safely' },
          { id: 'barefoot', name: 'Nature Feet', icon: 'ü¶∂', type: 'special', desc: 'Walk barefoot safely' },
          { id: 'night', name: 'Night Hiker', icon: 'üåÉ', type: 'special', desc: 'Hike at night' },
          { id: 'firstaid', name: 'Trail Medic', icon: 'ü©π', type: 'special', desc: 'Use first aid skills' },
          { id: 'fire', name: 'Fire Starter', icon: 'üî•', type: 'special', desc: 'Build a safe fire' },
          { id: 'knots', name: 'Knot Master', icon: 'ü™¢', type: 'special', desc: 'Tie useful knots' },
          { id: 'binoculars', name: 'Far Seer', icon: 'üî≠', type: 'special', desc: 'Use binoculars' },
          { id: 'whistle', name: 'Signal Master', icon: 'üì£', type: 'special', desc: 'Use safety whistle' },
          { id: 'fishing', name: 'Trail Fisher', icon: 'üé£', type: 'special', desc: 'Fish on the trail' },
          { id: 'wade', name: 'Water Walker', icon: 'üë£', type: 'special', desc: 'Wade through water' },
          { id: 'climb', name: 'Rock Climber', icon: 'üßó‚Äç‚ôÄÔ∏è', type: 'special', desc: 'Climb rocks safely' },
          { id: 'meditation', name: 'Trail Zen', icon: 'üßò', type: 'special', desc: 'Meditate in nature' },
        ];

        function FamilyHikeTracker() {
          const [hikes, setHikes] = useState([]);
          const [showForm, setShowForm] = useState(false);
          const [loading, setLoading] = useState(true);
          const [selectedBadge, setSelectedBadge] = useState(null);
          const [formData, setFormData] = useState({
            name: '',
            date: new Date().toISOString().split('T')[0],
            distance: '',
            elevation: '',
            location: '',
            notes: '',
            photoUrl: '',
            activities: []
          });

          useEffect(() => {
            loadHikes();
          }, []);

          const loadHikes = () => {
            try {
              const savedHikes = localStorage.getItem('familyHikes');
              if (savedHikes) {
                const loadedHikes = JSON.parse(savedHikes);
                setHikes(loadedHikes.sort((a, b) => new Date(b.date) - new Date(a.date)));
              }
            } catch (error) {
              console.log('Starting fresh - no saved hikes yet');
            }
            setLoading(false);
          };

          const saveHike = () => {
            if (!formData.name || !formData.distance) return;

            const newHike = {
              ...formData,
              id: Date.now().toString(),
              distance: parseFloat(formData.distance),
              elevation: parseFloat(formData.elevation) || 0,
              activities: formData.activities || []
            };

            const updatedHikes = [newHike, ...hikes];
            setHikes(updatedHikes);
            localStorage.setItem('familyHikes', JSON.stringify(updatedHikes));
            
            setFormData({
              name: '',
              date: new Date().toISOString().split('T')[0],
              distance: '',
              elevation: '',
              location: '',
              notes: '',
              photoUrl: '',
              activities: []
            });
            setShowForm(false);
          };

          const deleteHike = (id) => {
            const updatedHikes = hikes.filter(h => h.id !== id);
            setHikes(updatedHikes);
            localStorage.setItem('familyHikes', JSON.stringify(updatedHikes));
          };

          const exportData = () => {
            const dataStr = JSON.stringify(hikes, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `hike-together-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          };

          const importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const importedHikes = JSON.parse(e.target.result);
                if (Array.isArray(importedHikes)) {
                  // Merge with existing hikes, avoiding duplicates by ID
                  const existingIds = new Set(hikes.map(h => h.id));
                  const newHikes = importedHikes.filter(h => !existingIds.has(h.id));
                  const mergedHikes = [...hikes, ...newHikes].sort((a, b) => new Date(b.date) - new Date(a.date));
                  
                  setHikes(mergedHikes);
                  localStorage.setItem('familyHikes', JSON.stringify(mergedHikes));
                  alert(`Successfully imported ${newHikes.length} new hike(s)!`);
                } else {
                  alert('Invalid file format. Please select a valid backup file.');
                }
              } catch (error) {
                alert('Error reading file. Please make sure it\'s a valid Hike Together backup.');
              }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
          };

          const triggerImport = () => {
            document.getElementById('importFile').click();
          };

          const toggleActivity = (activityId) => {
            const newActivities = formData.activities.includes(activityId)
              ? formData.activities.filter(id => id !== activityId)
              : [...formData.activities, activityId];
            setFormData({ ...formData, activities: newActivities });
          };

          const totalDistance = hikes.reduce((sum, h) => sum + h.distance, 0);
          const totalElevation = hikes.reduce((sum, h) => sum + h.elevation, 0);
          
          const activityCounts = {};
          hikes.forEach(hike => {
            if (hike.activities) {
              hike.activities.forEach(activityId => {
                activityCounts[activityId] = (activityCounts[activityId] || 0) + 1;
              });
            }
          });
          
          const badgeStats = BADGES.map(badge => {
            let earned = false;
            let count = 0;
            
            if (badge.type === 'count') {
              earned = hikes.length >= badge.requirement;
              count = hikes.length;
            } else if (badge.type === 'distance') {
              earned = totalDistance >= badge.requirement;
              count = Math.floor(totalDistance);
            } else if (badge.type === 'elevation') {
              earned = totalElevation >= badge.requirement;
              count = Math.floor(totalElevation);
            } else {
              count = activityCounts[badge.id] || 0;
              earned = count > 0;
            }
            
            return { ...badge, earned, count };
          });
          
          const earnedBadges = badgeStats.filter(b => b.earned);
          const availableBadges = badgeStats.filter(b => !b.earned);
          
          // Group badges by category
          const badgeCategories = {
            'Milestones': badgeStats.filter(b => b.type === 'count' || b.type === 'distance' || b.type === 'elevation'),
            'Wildlife & Creatures': badgeStats.filter(b => ['wildlife', 'bird', 'butterfly', 'frog', 'squirrel', 'snake', 'turtle', 'rabbit', 'fish', 'bee', 'spider'].includes(b.id)),
            'Nature & Scenery': badgeStats.filter(b => ['waterfall', 'mushroom', 'wildflower', 'treeclimb', 'pinecone', 'rock', 'feather', 'stream', 'cave', 'bridge', 'sunset', 'sunrise', 'rainbow', 'fog', 'snow', 'rain', 'acorn', 'leaf', 'stick', 'tracks', 'berries', 'nest', 'fossil', 'crystal', 'clouds', 'wind', 'moon'].includes(b.id)),
            'Locations': badgeStats.filter(b => b.type === 'location'),
            'Activities & Challenges': badgeStats.filter(b => b.type === 'special')
          };
          
          const selectableActivities = BADGES.filter(b => 
            b.type === 'discovery' || b.type === 'location' || b.type === 'special'
          );

          if (loading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center">
                <div className="text-2xl text-green-600">Loading adventures...</div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
              {selectedBadge && (
                <BadgeModal 
                  badge={selectedBadge} 
                  onClose={() => setSelectedBadge(null)} 
                />
              )}
              
              <div className="max-w-4xl mx-auto">
                <div className="text-center mb-8">
                  <h1 className="text-4xl font-bold text-green-800 mb-2 flex items-center justify-center gap-2">
                    <Mountain />
                    Hike Together
                  </h1>
                  <p className="text-green-600">Track your amazing outdoor journeys!</p>
                  
                  {/* Backup Controls */}
                  <div className="flex gap-2 justify-center mt-4">
                    <button
                      onClick={exportData}
                      className="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow transition flex items-center gap-2"
                      title="Download a backup of all your hikes"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" x2="12" y1="15" y2="3"/>
                      </svg>
                      Download Backup
                    </button>
                    <button
                      onClick={triggerImport}
                      className="bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow transition flex items-center gap-2"
                      title="Restore hikes from a backup file"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" x2="12" y1="3" y2="15"/>
                      </svg>
                      Restore Backup
                    </button>
                    <input
                      id="importFile"
                      type="file"
                      accept=".json"
                      onChange={importData}
                      style={{ display: 'none' }}
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-8 h-8 mx-auto mb-2 text-green-600">
                      <path d="m8 3 4 8 5-5 5 15H2L8 3z"/>
                    </svg>
                    <div className="text-3xl font-bold text-green-800">{hikes.length}</div>
                    <div className="text-gray-600 text-sm">Total Hikes</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-8 h-8 mx-auto mb-2 text-blue-600">
                      <path d="M5 12h14"/>
                      <path d="m12 5 7 7-7 7"/>
                    </svg>
                    <div className="text-3xl font-bold text-blue-800">{totalDistance.toFixed(1)}</div>
                    <div className="text-gray-600 text-sm">Miles Hiked</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-8 h-8 mx-auto mb-2 text-purple-600">
                      <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/>
                      <polyline points="16 7 22 7 22 13"/>
                    </svg>
                    <div className="text-3xl font-bold text-purple-800">{totalElevation.toLocaleString()}</div>
                    <div className="text-gray-600 text-sm">Feet Climbed</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-8 h-8 mx-auto mb-2 text-yellow-600">
                      <circle cx="12" cy="8" r="6"/>
                      <path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/>
                    </svg>
                    <div className="text-3xl font-bold text-yellow-800">{earnedBadges.length}</div>
                    <div className="text-gray-600 text-sm">Badges Earned</div>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-md p-6 mb-8">
                  <h2 className="text-2xl font-bold text-green-800 mb-6 flex items-center gap-2">
                    <Award />
                    Achievement Badges ({earnedBadges.length}/{BADGES.length})
                  </h2>
                  
                  {earnedBadges.length > 0 && (
                    <div className="mb-8">
                      <h3 className="text-xl font-semibold text-green-700 mb-4 pb-2 border-b-2 border-green-200">üéâ Earned Badges</h3>
                      
                      {Object.entries(badgeCategories).map(([category, badges]) => {
                        const earnedInCategory = badges.filter(b => b.earned);
                        if (earnedInCategory.length === 0) return null;
                        
                        return (
                          <div key={category} className="mb-6">
                            <h4 className="text-md font-semibold text-green-600 mb-3">
                              {category}
                            </h4>
                            <div className="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-8 gap-3 pl-4">
                              {earnedInCategory.map(badge => (
                                <div
                                  key={badge.id}
                                  className="text-center p-3 rounded-lg bg-yellow-50 border-2 border-yellow-400 relative cursor-pointer hover:shadow-lg transition group"
                                  onClick={() => setSelectedBadge(badge)}
                                >
                                  <div className="text-3xl mb-1">{badge.icon}</div>
                                  <div className="font-semibold text-xs leading-tight break-words overflow-hidden" style={{minHeight: '2.5rem'}}>{badge.name}</div>
                                  {badge.count > 0 && badge.type !== 'count' && (
                                    <div className="absolute -top-2 -right-2 bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">
                                      {badge.count}
                                    </div>
                                  )}
                                  <div className="absolute top-1 right-1 bg-green-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">
                                    ?
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                  
                  <div>
                    <h3 className="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b-2 border-gray-200">üîí Locked Badges</h3>
                    
                    {Object.entries(badgeCategories).map(([category, badges]) => {
                      const lockedInCategory = badges.filter(b => !b.earned);
                      if (lockedInCategory.length === 0) return null;
                      
                      return (
                        <div key={category} className="mb-6">
                          <h4 className="text-md font-semibold text-gray-600 mb-3">
                            {category}
                          </h4>
                          <div className="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-8 gap-3 pl-4">
                            {lockedInCategory.map(badge => (
                              <div
                                key={badge.id}
                                className="text-center p-3 rounded-lg bg-gray-50 border-2 border-gray-200 opacity-50 relative cursor-pointer hover:opacity-70 transition group"
                                onClick={() => setSelectedBadge(badge)}
                              >
                                <div className="text-3xl mb-1">{badge.icon}</div>
                                <div className="font-semibold text-xs leading-tight break-words overflow-hidden" style={{minHeight: '2.5rem'}}>{badge.name}</div>
                                <div className="absolute top-1 right-1 bg-gray-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">
                                  ?
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                <button
                  onClick={() => setShowForm(!showForm)}
                  className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg mb-6 flex items-center justify-center gap-2 transition"
                >
                  <Plus />
                  Add New Hike
                </button>

                {showForm && (
                  <div className="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 className="text-2xl font-bold text-green-800 mb-4">Record Your Adventure</h2>
                    <div className="space-y-4">
                      <input
                        type="text"
                        placeholder="Hike Name (e.g., Sunset Trail)"
                        value={formData.name}
                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none"
                      />
                      <input
                        type="date"
                        value={formData.date}
                        onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                        className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none"
                      />
                      <input
                        type="number"
                        step="0.1"
                        placeholder="Distance (miles)"
                        value={formData.distance}
                        onChange={(e) => setFormData({ ...formData, distance: e.target.value })}
                        className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none"
                      />
                      <input
                        type="number"
                        placeholder="Elevation Gain (feet, optional)"
                        value={formData.elevation}
                        onChange={(e) => setFormData({ ...formData, elevation: e.target.value })}
                        className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none"
                      />
                      <input
                        type="text"
                        placeholder="Location (optional)"
                        value={formData.location}
                        onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                        className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none"
                      />
                      <textarea
                        placeholder="Notes about your adventure (optional)"
                        value={formData.notes}
                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                        className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none h-24"
                      />
                      
                      <div className="border-2 border-green-200 rounded-lg p-4">
                        <h3 className="font-semibold text-green-800 mb-2">üèÜ What did you do/see on this hike?</h3>
                        <p className="text-sm text-gray-600 mb-3">Select everything you experienced!</p>
                        
                        {/* Wildlife & Creatures */}
                        <div className="mb-4">
                          <h4 className="text-xs font-semibold text-gray-600 mb-2">Wildlife & Creatures</h4>
                          <div className="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                            {selectableActivities.filter(b => ['wildlife', 'bird', 'butterfly', 'frog', 'squirrel', 'snake', 'turtle', 'rabbit', 'fish', 'bee', 'spider'].includes(b.id)).map(badge => {
                              const selected = formData.activities.includes(badge.id);
                              return (
                                <button
                                  key={badge.id}
                                  type="button"
                                  onClick={() => toggleActivity(badge.id)}
                                  className={`p-2 rounded-lg border-2 transition transform ${
                                    selected
                                      ? 'bg-yellow-50 border-yellow-400 scale-105 shadow-md'
                                      : 'bg-white border-gray-200 hover:border-green-300 hover:shadow'
                                  }`}
                                  title={badge.desc}
                                >
                                  <div className="text-2xl mb-1">{badge.icon}</div>
                                  <div className="text-xs font-medium leading-tight break-words" style={{minHeight: '2rem'}}>{badge.name}</div>
                                </button>
                              );
                            })}
                          </div>
                        </div>
                        
                        {/* Nature & Scenery */}
                        <div className="mb-4">
                          <h4 className="text-xs font-semibold text-gray-600 mb-2">Nature & Scenery</h4>
                          <div className="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                            {selectableActivities.filter(b => ['waterfall', 'mushroom', 'wildflower', 'treeclimb', 'pinecone', 'rock', 'feather', 'stream', 'cave', 'bridge', 'sunset', 'sunrise', 'rainbow', 'fog', 'snow', 'rain', 'acorn', 'leaf', 'stick', 'tracks', 'berries', 'nest', 'fossil', 'crystal', 'clouds', 'wind', 'moon'].includes(b.id)).map(badge => {
                              const selected = formData.activities.includes(badge.id);
                              return (
                                <button
                                  key={badge.id}
                                  type="button"
                                  onClick={() => toggleActivity(badge.id)}
                                  className={`p-2 rounded-lg border-2 transition transform ${
                                    selected
                                      ? 'bg-yellow-50 border-yellow-400 scale-105 shadow-md'
                                      : 'bg-white border-gray-200 hover:border-green-300 hover:shadow'
                                  }`}
                                  title={badge.desc}
                                >
                                  <div className="text-2xl mb-1">{badge.icon}</div>
                                  <div className="text-xs font-medium leading-tight break-words" style={{minHeight: '2rem'}}>{badge.name}</div>
                                </button>
                              );
                            })}
                          </div>
                        </div>
                        
                        {/* Locations */}
                        <div className="mb-4">
                          <h4 className="text-xs font-semibold text-gray-600 mb-2">Locations</h4>
                          <div className="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                            {selectableActivities.filter(b => b.type === 'location').map(badge => {
                              const selected = formData.activities.includes(badge.id);
                              return (
                                <button
                                  key={badge.id}
                                  type="button"
                                  onClick={() => toggleActivity(badge.id)}
                                  className={`p-2 rounded-lg border-2 transition transform ${
                                    selected
                                      ? 'bg-yellow-50 border-yellow-400 scale-105 shadow-md'
                                      : 'bg-white border-gray-200 hover:border-green-300 hover:shadow'
                                  }`}
                                  title={badge.desc}
                                >
                                  <div className="text-2xl mb-1">{badge.icon}</div>
                                  <div className="text-xs font-medium leading-tight break-words" style={{minHeight: '2rem'}}>{badge.name}</div>
                                </button>
                              );
                            })}
                          </div>
                        </div>
                        
                        {/* Activities & Challenges */}
                        <div>
                          <h4 className="text-xs font-semibold text-gray-600 mb-2">Activities & Challenges</h4>
                          <div className="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                            {selectableActivities.filter(b => b.type === 'special').map(badge => {
                              const selected = formData.activities.includes(badge.id);
                              return (
                                <button
                                  key={badge.id}
                                  type="button"
                                  onClick={() => toggleActivity(badge.id)}
                                  className={`p-2 rounded-lg border-2 transition transform ${
                                    selected
                                      ? 'bg-yellow-50 border-yellow-400 scale-105 shadow-md'
                                      : 'bg-white border-gray-200 hover:border-green-300 hover:shadow'
                                  }`}
                                  title={badge.desc}
                                >
                                  <div className="text-2xl mb-1">{badge.icon}</div>
                                  <div className="text-xs font-medium leading-tight break-words" style={{minHeight: '2rem'}}>{badge.name}</div>
                                </button>
                              );
                            })}
                          </div>
                        </div>
                      </div>
                      
                      <div className="flex gap-2">
                        <button
                          onClick={saveHike}
                          className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition"
                        >
                          Save Hike
                        </button>
                        <button
                          onClick={() => setShowForm(false)}
                          className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                <div className="space-y-4">
                  <h2 className="text-2xl font-bold text-green-800 mb-4">Your Hiking Journey</h2>
                  {hikes.length === 0 ? (
                    <div className="bg-white rounded-lg shadow-md p-8 text-center text-gray-500">
                      <Mountain className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                      <p className="text-xl">No hikes recorded yet!</p>
                      <p className="mt-2">Click "Add New Hike" to start your adventure log.</p>
                    </div>
                  ) : (
                    hikes.map(hike => (
                      <div key={hike.id} className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex justify-between items-start mb-3">
                          <div>
                            <h3 className="text-xl font-bold text-green-800">{hike.name}</h3>
                            <div className="flex items-center gap-4 text-gray-600 text-sm mt-1">
                              <span className="flex items-center gap-1">
                                <Calendar />
                                {new Date(hike.date).toLocaleDateString()}
                              </span>
                              {hike.location && (
                                <span className="flex items-center gap-1">
                                  <MapPin />
                                  {hike.location}
                                </span>
                              )}
                            </div>
                          </div>
                          <button
                            onClick={() => deleteHike(hike.id)}
                            className="text-red-500 hover:text-red-700 text-sm"
                          >
                            Delete
                          </button>
                        </div>
                        {hike.photoUrl && (
                          <img
                            src={hike.photoUrl}
                            alt={hike.name}
                            className="w-full h-48 object-cover rounded-lg mb-3"
                          />
                        )}
                        <div className="flex gap-4 mb-3">
                          <div className="bg-blue-50 px-4 py-2 rounded-lg">
                            <div className="text-blue-800 font-bold">{hike.distance} mi</div>
                            <div className="text-blue-600 text-sm">Distance</div>
                          </div>
                          {hike.elevation > 0 && (
                            <div className="bg-purple-50 px-4 py-2 rounded-lg">
                              <div className="text-purple-800 font-bold">{hike.elevation} ft</div>
                              <div className="text-purple-600 text-sm">Elevation</div>
                            </div>
                          )}
                        </div>
                        {hike.notes && (
                          <p className="text-gray-700 bg-gray-50 p-3 rounded-lg mb-3">{hike.notes}</p>
                        )}
                        {hike.activities && hike.activities.length > 0 && (
                          <div className="mt-3">
                            <div className="text-sm font-semibold text-gray-700 mb-2">Badges Earned on This Hike:</div>
                            <div className="flex flex-wrap gap-2">
                              {hike.activities.map(activityId => {
                                const badge = BADGES.find(b => b.id === activityId);
                                return badge ? (
                                  <div
                                    key={activityId}
                                    className="bg-yellow-50 border-2 border-yellow-400 rounded-lg px-3 py-1 flex items-center gap-2"
                                    title={badge.desc}
                                  >
                                    <span className="text-xl">{badge.icon}</span>
                                    <span className="text-sm font-medium">{badge.name}</span>
                                  </div>
                                ) : null;
                              })}
                            </div>
                          </div>
                        )}
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.render(<FamilyHikeTracker />, document.getElementById('root'));
    </script>
</body>
</html>
