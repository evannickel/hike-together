<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hike Together</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif; }
        /* Center emojis in selector boxes */
        button[class*="text-3xl p-2"] { display: flex; align-items: center; justify-content: center; }
        /* Map styles */
        .leaflet-container { height: 100%; width: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // ‚ö†Ô∏è REPLACE WITH YOUR FIREBASE CONFIG
    const firebaseConfig = {
  apiKey: "AIzaSyDS6292P80pBlZ-rMVOAEwHfFEGo9RDDrk",
  authDomain: "hike-together-app.firebaseapp.com",
  projectId: "hike-together-app",
  storageBucket: "hike-together-app.firebasestorage.app",
  messagingSenderId: "773950556723",
  appId: "1:773950556723:web:36b9faae2ec3ceaeaa7146",
  measurementId: "G-WXFDKVVEER"
};

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const { useState, useEffect } = React;

        const AVATARS = ['üë®', 'üë©', 'üë¶', 'üëß', 'üßí', 'üë∂', 'üßë', 'üë¥', 'üëµ', 'üê∂', 'üê±', 'üêª', 'ü¶ä', 'ü¶Å', 'üêØ', 'ü¶Ñ'];
        const COLORS = ['#4CAF50', '#2196F3', '#FF9800', '#E91E63', '#9C27B0', '#00BCD4', '#FF5722', '#795548'];

        const Mountain = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m8 3 4 8 5-5 5 15H2L8 3z"/></svg>;
        const Award = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>;
        const Calendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="4" rx="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
        const MapPin = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
        const Plus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;

        const BadgeModal = ({ badge, onClose }) => {
          if (!badge) return null;
          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
              <div className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl" onClick={(e) => e.stopPropagation()}>
                <div className="text-center">
                  <div className="text-6xl mb-4">{badge.icon}</div>
                  <h3 className="text-2xl font-bold text-green-800 mb-2">{badge.name}</h3>
                  <p className="text-gray-600 mb-4">{badge.desc}</p>
                  {badge.requirement && <div className="bg-green-50 rounded-lg p-3 mb-4"><p className="text-sm font-semibold text-green-800">Requirement: {badge.requirement} {badge.type === 'count' ? 'hikes' : badge.type === 'distance' ? 'miles' : 'feet'}</p></div>}
                  {badge.milestone && badge.requirement && (
                    <div className="bg-blue-50 rounded-lg p-3 mb-4">
                      <p className="text-sm font-semibold text-blue-800">Progress: {badge.count} / {badge.requirement}</p>
                      {badge.earned && <p className="text-sm font-semibold text-green-600 mt-1">‚úì Achieved!</p>}
                    </div>
                  )}
                  {!badge.milestone && badge.earned && badge.count > 0 && <div className="bg-yellow-50 rounded-lg p-3 mb-4"><p className="text-sm font-semibold text-yellow-800">‚ú® Achieved {badge.count} times!</p></div>}
                  <button onClick={onClose} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Close</button>
                </div>
              </div>
            </div>
          );
        };

        const BADGES = [
          { id: 'first', name: 'First Steps', icon: 'ü•æ', type: 'count', requirement: 1, desc: 'Complete your first hike', milestone: true },
          { id: 'explorer', name: 'Explorer', icon: 'üó∫Ô∏è', type: 'count', requirement: 5, desc: 'Complete 5 hikes', milestone: true },
          { id: 'adventurer', name: 'Adventurer', icon: '‚õ∞Ô∏è', type: 'count', requirement: 10, desc: 'Complete 10 hikes', milestone: true },
          { id: 'trailblazer', name: 'Trailblazer', icon: 'üî•', type: 'count', requirement: 25, desc: 'Complete 25 hikes', milestone: true },
          { id: 'legend', name: 'Hiking Legend', icon: 'üëë', type: 'count', requirement: 50, desc: 'Complete 50 hikes', milestone: true },
          { id: 'century', name: 'Century Club', icon: 'üíØ', type: 'count', requirement: 100, desc: 'Complete 100 hikes', milestone: true },
          { id: 'distance10', name: 'First 10', icon: 'üèÉ', type: 'distance', requirement: 10, desc: 'Hike 10 total miles', milestone: true },
          { id: 'distance25', name: 'Quarter Century', icon: 'üö∂', type: 'distance', requirement: 25, desc: 'Hike 25 total miles', milestone: true },
          { id: 'distance50', name: 'Half Century', icon: 'ü•á', type: 'distance', requirement: 50, desc: 'Hike 50 total miles', milestone: true },
          { id: 'distance100', name: 'Centurion', icon: '‚≠ê', type: 'distance', requirement: 100, desc: 'Hike 100 total miles', milestone: true },
          { id: 'distance250', name: 'Ultra Hiker', icon: 'üí™', type: 'distance', requirement: 250, desc: 'Hike 250 total miles', milestone: true },
          { id: 'distance500', name: 'Marathon Master', icon: 'üèÜ', type: 'distance', requirement: 500, desc: 'Hike 500 total miles', milestone: true },
          { id: 'climber1k', name: 'Hill Climber', icon: 'üßó', type: 'elevation', requirement: 1000, desc: 'Climb 1,000 feet', milestone: true },
          { id: 'climber5k', name: 'Peak Climber', icon: 'üèîÔ∏è', type: 'elevation', requirement: 5000, desc: 'Climb 5,000 feet', milestone: true },
          { id: 'climber10k', name: 'Mountain Goat', icon: 'üêê', type: 'elevation', requirement: 10000, desc: 'Climb 10,000 feet', milestone: true },
          { id: 'climber25k', name: 'Everest Base', icon: 'üóª', type: 'elevation', requirement: 25000, desc: 'Climb 25,000 feet', milestone: true },
          { id: 'climber50k', name: 'Sky Walker', icon: '‚òÅÔ∏è', type: 'elevation', requirement: 50000, desc: 'Climb 50,000 feet', milestone: true },
          { id: 'climber100k', name: 'Altitude King', icon: 'üëë', type: 'elevation', requirement: 100000, desc: 'Climb 100,000 feet', milestone: true },
          { id: 'waterfall', name: 'Waterfall Finder', icon: 'üí¶', type: 'discovery', desc: 'Find a waterfall' },
          { id: 'wildlife', name: 'Wildlife Spotter', icon: 'ü¶å', type: 'discovery', desc: 'See a wild animal' },
          { id: 'bird', name: 'Bird Watcher', icon: 'ü¶Ö', type: 'discovery', desc: 'Spot a bird' },
          { id: 'butterfly', name: 'Butterfly Hunter', icon: 'ü¶ã', type: 'discovery', desc: 'See a butterfly' },
          { id: 'mushroom', name: 'Fungi Finder', icon: 'üçÑ', type: 'discovery', desc: 'Discover mushrooms' },
          { id: 'wildflower', name: 'Flower Power', icon: 'üå∏', type: 'discovery', desc: 'Find wildflowers' },
          { id: 'treeclimb', name: 'Tree Hugger', icon: 'üå≥', type: 'discovery', desc: 'Hug a big tree' },
          { id: 'pinecone', name: 'Pine Collector', icon: 'üå≤', type: 'discovery', desc: 'Collect a pinecone' },
          { id: 'rock', name: 'Rock Hound', icon: 'ü™®', type: 'discovery', desc: 'Find a cool rock' },
          { id: 'feather', name: 'Feather Finder', icon: 'ü™∂', type: 'discovery', desc: 'Find a feather' },
          { id: 'stream', name: 'Stream Crosser', icon: 'üåä', type: 'discovery', desc: 'Cross a stream' },
          { id: 'cave', name: 'Cave Explorer', icon: 'üï≥Ô∏è', type: 'discovery', desc: 'Explore a cave' },
          { id: 'bridge', name: 'Bridge Walker', icon: 'üåâ', type: 'discovery', desc: 'Cross a bridge' },
          { id: 'sunset', name: 'Sunset Chaser', icon: 'üåÖ', type: 'discovery', desc: 'Watch a sunset' },
          { id: 'sunrise', name: 'Early Bird', icon: 'üåÑ', type: 'discovery', desc: 'Watch a sunrise' },
          { id: 'rainbow', name: 'Rainbow Finder', icon: 'üåà', type: 'discovery', desc: 'See a rainbow' },
          { id: 'fog', name: 'Mist Walker', icon: 'üå´Ô∏è', type: 'discovery', desc: 'Hike in fog' },
          { id: 'snow', name: 'Snow Trekker', icon: '‚ùÑÔ∏è', type: 'discovery', desc: 'Hike in snow' },
          { id: 'rain', name: 'Rain Ranger', icon: 'üåßÔ∏è', type: 'discovery', desc: 'Hike in rain' },
          { id: 'frog', name: 'Frog Friend', icon: 'üê∏', type: 'discovery', desc: 'See a frog' },
          { id: 'squirrel', name: 'Squirrel Scout', icon: 'üêøÔ∏è', type: 'discovery', desc: 'Spot a squirrel' },
          { id: 'snake', name: 'Snake Spotter', icon: 'üêç', type: 'discovery', desc: 'See a snake' },
          { id: 'turtle', name: 'Turtle Tracker', icon: 'üê¢', type: 'discovery', desc: 'Find a turtle' },
          { id: 'rabbit', name: 'Bunny Buddy', icon: 'üê∞', type: 'discovery', desc: 'Spot a rabbit' },
          { id: 'fish', name: 'Fish Finder', icon: 'üêü', type: 'discovery', desc: 'See fish' },
          { id: 'acorn', name: 'Acorn Collector', icon: 'üå∞', type: 'discovery', desc: 'Collect an acorn' },
          { id: 'leaf', name: 'Leaf Lover', icon: 'üçÇ', type: 'discovery', desc: 'Find a pretty leaf' },
          { id: 'stick', name: 'Walking Stick', icon: 'ü¶Ø', type: 'discovery', desc: 'Find a hiking stick' },
          { id: 'bee', name: 'Bee Keeper', icon: 'üêù', type: 'discovery', desc: 'See a bee' },
          { id: 'spider', name: 'Spider Scout', icon: 'üï∑Ô∏è', type: 'discovery', desc: 'Find a spider web' },
          { id: 'tracks', name: 'Track Finder', icon: 'üêæ', type: 'discovery', desc: 'Find animal tracks' },
          { id: 'berries', name: 'Berry Scout', icon: 'ü´ê', type: 'discovery', desc: 'Find wild berries' },
          { id: 'nest', name: 'Nest Finder', icon: 'ü™π', type: 'discovery', desc: 'Find a bird nest' },
          { id: 'fossil', name: 'Time Detective', icon: 'ü¶¥', type: 'discovery', desc: 'Find a fossil' },
          { id: 'crystal', name: 'Crystal Hunter', icon: 'üíé', type: 'discovery', desc: 'Find crystals' },
          { id: 'clouds', name: 'Cloud Watcher', icon: '‚òÅÔ∏è', type: 'discovery', desc: 'Watch clouds' },
          { id: 'wind', name: 'Wind Rider', icon: 'üí®', type: 'discovery', desc: 'Hike in wind' },
          { id: 'moon', name: 'Moon Gazer', icon: 'üåô', type: 'discovery', desc: 'See the moon' },
          { id: 'beach', name: 'Beach Comber', icon: 'üèñÔ∏è', type: 'location', desc: 'Hike at beach' },
          { id: 'desert', name: 'Desert Wanderer', icon: 'üèúÔ∏è', type: 'location', desc: 'Hike in desert' },
          { id: 'forest', name: 'Forest Friend', icon: 'üå≤', type: 'location', desc: 'Hike in forest' },
          { id: 'mountain', name: 'Mountain Master', icon: '‚õ∞Ô∏è', type: 'location', desc: 'Hike mountains' },
          { id: 'canyon', name: 'Canyon Explorer', icon: 'üèûÔ∏è', type: 'location', desc: 'Hike in canyon' },
          { id: 'lake', name: 'Lake Lover', icon: 'üèûÔ∏è', type: 'location', desc: 'Hike around lake' },
          { id: 'river', name: 'River Runner', icon: 'üèûÔ∏è', type: 'location', desc: 'Hike along river' },
          { id: 'statepark', name: 'Park Visitor', icon: 'üèïÔ∏è', type: 'location', desc: 'Visit state park' },
          { id: 'nationalpark', name: 'Park Ranger', icon: 'üéñÔ∏è', type: 'location', desc: 'Visit national park' },
          { id: 'meadow', name: 'Meadow Walker', icon: 'üåæ', type: 'location', desc: 'Hike through meadow' },
          { id: 'wetland', name: 'Wetland Explorer', icon: 'ü¶Ü', type: 'location', desc: 'Visit wetland' },
          { id: 'jungle', name: 'Jungle Trekker', icon: 'üå¥', type: 'location', desc: 'Hike in jungle' },
          { id: 'prairie', name: 'Prairie Walker', icon: 'üåª', type: 'location', desc: 'Hike prairie' },
          { id: 'tundra', name: 'Tundra Explorer', icon: 'üßä', type: 'location', desc: 'Hike in tundra' },
          { id: 'volcano', name: 'Volcano Adventurer', icon: 'üåã', type: 'location', desc: 'Hike near volcano' },
          { id: 'family', name: 'Family Time', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', type: 'special', desc: 'Family hikes together' },
          { id: 'picnic', name: 'Trail Feast', icon: 'üß∫', type: 'special', desc: 'Have trail picnic' },
          { id: 'camping', name: 'Happy Camper', icon: '‚õ∫', type: 'special', desc: 'Camp overnight' },
          { id: 'stargazing', name: 'Star Gazer', icon: '‚≠ê', type: 'special', desc: 'Stargaze on trail' },
          { id: 'geocache', name: 'Treasure Hunter', icon: 'üíé', type: 'special', desc: 'Find geocache' },
          { id: 'summit', name: 'Summit Seeker', icon: 'üéØ', type: 'special', desc: 'Reach a summit' },
          { id: 'lighthouse', name: 'Light Keeper', icon: 'üóº', type: 'special', desc: 'Visit lighthouse' },
          { id: 'historic', name: 'Time Traveler', icon: 'üèõÔ∏è', type: 'special', desc: 'Visit historic site' },
          { id: 'photog', name: 'Photo Pro', icon: 'üì∏', type: 'special', desc: 'Take photos' },
          { id: 'notrail', name: 'Off Beaten Path', icon: 'üß≠', type: 'special', desc: 'Hike off-trail' },
          { id: 'leader', name: 'Trail Leader', icon: 'üßë‚Äçüè´', type: 'special', desc: 'Lead the group' },
          { id: 'map', name: 'Navigator', icon: 'üó∫Ô∏è', type: 'special', desc: 'Use map/compass' },
          { id: 'journal', name: 'Nature Writer', icon: 'üìì', type: 'special', desc: 'Write in journal' },
          { id: 'art', name: 'Trail Artist', icon: 'üé®', type: 'special', desc: 'Draw/paint on trail' },
          { id: 'song', name: 'Trail Singer', icon: 'üéµ', type: 'special', desc: 'Sing hiking songs' },
          { id: 'story', name: 'Story Teller', icon: 'üìö', type: 'special', desc: 'Tell stories' },
          { id: 'game', name: 'Trail Games', icon: 'üé≤', type: 'special', desc: 'Play trail games' },
          { id: 'clean', name: 'Trail Keeper', icon: '‚ôªÔ∏è', type: 'special', desc: 'Pick up litter' },
          { id: 'help', name: 'Helpful Hiker', icon: 'ü§ù', type: 'special', desc: 'Help another hiker' },
          { id: 'courage', name: 'Brave Heart', icon: 'üí™', type: 'special', desc: 'Overcome a fear' },
          { id: 'early', name: 'Morning Glory', icon: 'üåû', type: 'special', desc: 'Start before 7am' },
          { id: 'long', name: 'Endurance Pro', icon: '‚è±Ô∏è', type: 'special', desc: 'Hike 4+ hours' },
          { id: 'quiet', name: 'Silent Steps', icon: 'ü§´', type: 'special', desc: 'Hike in silence' },
          { id: 'backwards', name: 'Backwards Walker', icon: 'üîÑ', type: 'special', desc: 'Walk backwards' },
          { id: 'barefoot', name: 'Nature Feet', icon: 'ü¶∂', type: 'special', desc: 'Walk barefoot' },
          { id: 'night', name: 'Night Hiker', icon: 'üåÉ', type: 'special', desc: 'Hike at night' },
          { id: 'firstaid', name: 'Trail Medic', icon: 'ü©π', type: 'special', desc: 'Use first aid' },
          { id: 'fire', name: 'Fire Starter', icon: 'üî•', type: 'special', desc: 'Build safe fire' },
          { id: 'knots', name: 'Knot Master', icon: 'ü™¢', type: 'special', desc: 'Tie useful knots' },
          { id: 'binoculars', name: 'Far Seer', icon: 'üî≠', type: 'special', desc: 'Use binoculars' },
          { id: 'whistle', name: 'Signal Master', icon: 'üì£', type: 'special', desc: 'Use safety whistle' },
          { id: 'fishing', name: 'Trail Fisher', icon: 'üé£', type: 'special', desc: 'Fish on trail' },
          { id: 'wade', name: 'Water Walker', icon: 'üë£', type: 'special', desc: 'Wade through water' },
          { id: 'climb', name: 'Rock Climber', icon: 'üßó‚Äç‚ôÄÔ∏è', type: 'special', desc: 'Climb rocks' },
          { id: 'meditation', name: 'Trail Zen', icon: 'üßò', type: 'special', desc: 'Meditate in nature' },
        ];

        // Map Component
        const MapComponent = ({ hikes, currentMember }) => {
          const mapRef = React.useRef(null);
          const mapInstanceRef = React.useRef(null);
          const [draggingHike, setDraggingHike] = React.useState(null);
          
          const updateHikeLocation = async (hikeId, newLat, newLng) => {
            try {
              const user = firebase.auth().currentUser;
              if (!user) return;
              
              const familyId = localStorage.getItem('familyId');
              await firebase.firestore().collection('families').doc(familyId).collection('hikes').doc(hikeId).update({
                lat: newLat,
                lng: newLng
              });
            } catch (error) {
              console.error('Error updating location:', error);
              alert('Failed to update marker location');
            }
          };
          
          React.useEffect(() => {
            if (!mapRef.current || mapInstanceRef.current) return;
            
            // Initialize map
            const map = L.map(mapRef.current).setView([39.8283, -98.5795], 4); // Center of USA
            mapInstanceRef.current = map;
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '¬© OpenStreetMap contributors',
              maxZoom: 19
            }).addTo(map);
            
            return () => {
              if (mapInstanceRef.current) {
                mapInstanceRef.current.remove();
                mapInstanceRef.current = null;
              }
            };
          }, []);
          
          React.useEffect(() => {
            if (!mapInstanceRef.current) return;
            
            const map = mapInstanceRef.current;
            
            // Clear existing markers
            map.eachLayer(layer => {
              if (layer instanceof L.Marker) {
                map.removeLayer(layer);
              }
            });
            
            // Add markers for hikes with coordinates
            const hikesWithCoords = hikes.filter(h => h.lat && h.lng);
            
            if (hikesWithCoords.length === 0) {
              return;
            }
            
            hikesWithCoords.forEach(hike => {
              const difficultyColors = {
                easy: '#10b981',
                medium: '#f59e0b',
                hard: '#ef4444'
              };
              
              const difficultyIcons = {
                easy: 'üü¢',
                medium: 'üü°',
                hard: 'üî¥'
              };
              
              const markerColor = difficultyColors[hike.difficulty] || '#6b7280';
              
              const customIcon = L.divIcon({
                html: `<div style="background-color: ${markerColor}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;">${hike.hikerAvatar || 'ü•æ'}</div>`,
                className: 'custom-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
              });
              
              const marker = L.marker([hike.lat, hike.lng], { 
                icon: customIcon,
                draggable: true  // Make marker draggable
              }).addTo(map);
              
              // Handle marker drag events
              marker.on('dragstart', () => {
                setDraggingHike(hike.name);
              });
              
              marker.on('dragend', async (e) => {
                const newPos = e.target.getLatLng();
                await updateHikeLocation(hike.id, newPos.lat, newPos.lng);
                setDraggingHike(null);
              });
              
              const popupContent = `
                <div style="min-width: 200px;">
                  <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px; color: #065f46;">
                    ${hike.hikerAvatar || 'ü•æ'} ${hike.name}
                  </div>
                  ${hike.difficulty ? `<div style="margin-bottom: 4px;"><strong>${difficultyIcons[hike.difficulty] || ''} ${hike.difficulty.charAt(0).toUpperCase() + hike.difficulty.slice(1)}</strong></div>` : ''}
                  <div style="margin-bottom: 4px;"><strong>Date:</strong> ${new Date(hike.date).toLocaleDateString()}</div>
                  <div style="margin-bottom: 4px;"><strong>Distance:</strong> ${hike.distance} miles</div>
                  ${hike.elevation ? `<div style="margin-bottom: 4px;"><strong>Elevation:</strong> ${hike.elevation} ft</div>` : ''}
                  ${hike.location ? `<div style="margin-bottom: 4px;"><strong>Location:</strong> ${hike.location}</div>` : ''}
                  ${hike.notes ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-style: italic; color: #6b7280;">${hike.notes}</div>` : ''}
                  <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">
                    üí° Drag marker to adjust location
                  </div>
                </div>
              `;
              
              marker.bindPopup(popupContent);
            });
            
            // Fit map to show all markers
            if (hikesWithCoords.length > 0) {
              const bounds = L.latLngBounds(hikesWithCoords.map(h => [h.lat, h.lng]));
              map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
            }
          }, [hikes]);
          
          const hikesWithCoords = hikes.filter(h => h.lat && h.lng);
          
          return (
            <div>
              {draggingHike && (
                <div className="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-2 rounded-lg text-sm mb-4">
                  üìç Adjusting location for "{draggingHike}"... Release to save new position
                </div>
              )}
              {hikesWithCoords.length === 0 ? (
                <div className="text-center py-12">
                  <MapPin className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                  <p className="text-xl text-gray-500 mb-2">No mapped hikes yet!</p>
                  <p className="text-sm text-gray-400">Add a location when recording a hike to see it on the map.</p>
                </div>
              ) : (
                <div>
                  <p className="text-sm text-gray-600 mb-4">
                    Showing {hikesWithCoords.length} of {hikes.length} hikes on the map
                    {hikesWithCoords.length < hikes.length && ` (${hikes.length - hikesWithCoords.length} hike${hikes.length - hikesWithCoords.length > 1 ? 's' : ''} without location)`}
                  </p>
                  <div ref={mapRef} style={{ height: '500px', borderRadius: '8px' }} />
                </div>
              )}
            </div>
          );
        };

        function App() {
          const [user, setUser] = useState(null);
          const [familyId, setFamilyId] = useState(null);
          const [familyName, setFamilyName] = useState('');
          const [members, setMembers] = useState([]);
          const [currentMember, setCurrentMember] = useState(null);
          const [hikes, setHikes] = useState([]);
          const [loading, setLoading] = useState(true);
          const [showSetup, setShowSetup] = useState(false);
          const [setupStep, setSetupStep] = useState('family');
          const [newFamilyName, setNewFamilyName] = useState('');
          const [joinCode, setJoinCode] = useState('');
          const [newMemberName, setNewMemberName] = useState('');
          const [newMemberAvatar, setNewMemberAvatar] = useState('üë¶');
          const [newMemberColor, setNewMemberColor] = useState('#4CAF50');
          const [showMemberMenu, setShowMemberMenu] = useState(false);
          const [showForm, setShowForm] = useState(false);
          const [selectedBadge, setSelectedBadge] = useState(null);
          const [activeView, setActiveView] = useState('badges'); // 'badges' or 'map'
          const [geocodingStatus, setGeocodingStatus] = useState('');
          const [editingHike, setEditingHike] = useState(null); // Track which hike is being edited
          const [currentPage, setCurrentPage] = useState('home'); // 'home', 'gear', 'about'
          const [formData, setFormData] = useState({
            name: '', date: new Date().toISOString().split('T')[0], distance: '', elevation: '', difficulty: 'easy', location: '', notes: '', activities: []
          });

          useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(async (user) => {
              if (user) {
                setUser(user);
                const storedFamilyId = localStorage.getItem('familyId');
                const storedMemberId = localStorage.getItem('currentMemberId');
                if (storedFamilyId) {
                  await loadFamily(storedFamilyId, storedMemberId);
                } else {
                  setShowSetup(true);
                  setLoading(false);
                }
              } else {
                await auth.signInAnonymously();
              }
            });
            return unsubscribe;
          }, []);

          const loadFamily = async (famId, memberId) => {
            try {
              setFamilyId(famId);
              const familyDoc = await db.collection('families').doc(famId).get();
              if (familyDoc.exists) setFamilyName(familyDoc.data().name);
              const membersSnap = await db.collection('families').doc(famId).collection('members').get();
              const membersList = membersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setMembers(membersList);
              if (memberId && membersList.find(m => m.id === memberId)) {
                setCurrentMember(membersList.find(m => m.id === memberId));
              } else if (membersList.length > 0) {
                setCurrentMember(membersList[0]);
                localStorage.setItem('currentMemberId', membersList[0].id);
              }
              db.collection('families').doc(famId).collection('hikes').orderBy('date', 'desc').onSnapshot(snapshot => {
                setHikes(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
              });
              setLoading(false);
            } catch (error) {
              console.error(error);
              setLoading(false);
            }
          };

          const createFamily = async () => {
            if (!newFamilyName.trim()) return;
            try {
              const familyRef = db.collection('families').doc();
              await familyRef.set({ name: newFamilyName, createdAt: firebase.firestore.FieldValue.serverTimestamp(), ownerId: user.uid });
              localStorage.setItem('familyId', familyRef.id);
              setFamilyId(familyRef.id);
              setFamilyName(newFamilyName);
              setSetupStep('member');
            } catch (error) {
              alert('Error: ' + error.message);
            }
          };

          const joinFamily = async () => {
            if (!joinCode.trim()) return;
            try {
              const familyDoc = await db.collection('families').doc(joinCode).get();
              if (familyDoc.exists) {
                localStorage.setItem('familyId', joinCode);
                await loadFamily(joinCode, null);
                setShowSetup(false);
              } else {
                alert('Family not found');
              }
            } catch (error) {
              alert('Error: ' + error.message);
            }
          };

          const createMember = async () => {
            if (!newMemberName.trim()) return;
            try {
              const memberRef = await db.collection('families').doc(familyId).collection('members').add({
                name: newMemberName, avatar: newMemberAvatar, color: newMemberColor, createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              const newMember = { id: memberRef.id, name: newMemberName, avatar: newMemberAvatar, color: newMemberColor };
              setMembers([...members, newMember]);
              setCurrentMember(newMember);
              localStorage.setItem('currentMemberId', memberRef.id);
              setShowSetup(false);
              setNewMemberName('');
            } catch (error) {
              alert('Error: ' + error.message);
            }
          };

          const switchMember = (member) => {
            setCurrentMember(member);
            localStorage.setItem('currentMemberId', member.id);
            setShowMemberMenu(false);
          };

          const saveHike = async () => {
            if (!formData.name || !formData.distance || !currentMember) return;
            try {
              setGeocodingStatus(editingHike ? 'Updating hike...' : 'Saving hike...');
              
              // Geocode location if provided and changed
              let lat = editingHike ? editingHike.lat : null;
              let lng = editingHike ? editingHike.lng : null;
              
              if (formData.location && formData.location.trim()) {
                // Only re-geocode if location changed or no coordinates exist
                if (!editingHike || formData.location !== editingHike.location || !editingHike.lat) {
                  setGeocodingStatus('Finding location on map...');
                  try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(formData.location)}&limit=1`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                      lat = parseFloat(data[0].lat);
                      lng = parseFloat(data[0].lon);
                    }
                  } catch (geoError) {
                    console.log('Geocoding failed:', geoError);
                    // Continue saving without new coordinates
                  }
                }
              } else {
                // Location cleared, remove coordinates
                lat = null;
                lng = null;
              }

              const hikeData = {
                ...formData, 
                distance: parseFloat(formData.distance), 
                elevation: parseFloat(formData.elevation) || 0,
                lat: lat,
                lng: lng,
                hikerId: currentMember.id, 
                hikerName: currentMember.name, 
                hikerAvatar: currentMember.avatar,
              };

              if (editingHike) {
                // Update existing hike
                await db.collection('families').doc(familyId).collection('hikes').doc(editingHike.id).update(hikeData);
              } else {
                // Create new hike
                await db.collection('families').doc(familyId).collection('hikes').add({
                  ...hikeData,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
              
              setFormData({ name: '', date: new Date().toISOString().split('T')[0], distance: '', elevation: '', difficulty: 'easy', location: '', notes: '', activities: [] });
              setGeocodingStatus('');
              setShowForm(false);
              setEditingHike(null);
            } catch (error) {
              alert('Error: ' + error.message);
              setGeocodingStatus('');
            }
          };

          const deleteHike = async (id) => {
            try {
              await db.collection('families').doc(familyId).collection('hikes').doc(id).delete();
            } catch (error) {
              alert('Error: ' + error.message);
            }
          };

          const editHike = (hike) => {
            setEditingHike(hike);
            setFormData({
              name: hike.name,
              date: hike.date,
              distance: hike.distance.toString(),
              elevation: hike.elevation ? hike.elevation.toString() : '',
              difficulty: hike.difficulty || 'easy',
              location: hike.location || '',
              notes: hike.notes || '',
              activities: hike.activities || []
            });
            setShowForm(true);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };

          const toggleActivity = (activityId) => {
            const newActivities = formData.activities.includes(activityId) ? formData.activities.filter(id => id !== activityId) : [...formData.activities, activityId];
            setFormData({ ...formData, activities: newActivities });
          };

          const copyFamilyCode = () => {
            navigator.clipboard.writeText(familyId);
            alert('Family code copied!');
          };

          const memberHikes = hikes.filter(h => !currentMember || h.hikerId === currentMember.id);
          const totalDistance = memberHikes.reduce((sum, h) => sum + h.distance, 0);
          const totalElevation = memberHikes.reduce((sum, h) => sum + h.elevation, 0);
          const longestHike = memberHikes.length > 0 ? Math.max(...memberHikes.map(h => h.distance || 0)) : 0;
          const highestElevation = memberHikes.length > 0 ? Math.max(...memberHikes.map(h => h.elevation || 0)) : 0;
          
          const activityCounts = {};
          memberHikes.forEach(hike => {
            if (hike.activities) {
              hike.activities.forEach(activityId => {
                activityCounts[activityId] = (activityCounts[activityId] || 0) + 1;
              });
            }
          });
          
          const badgeStats = BADGES.map(badge => {
            let earned = false, count = 0;
            if (badge.type === 'count') { 
              earned = memberHikes.length >= badge.requirement; 
              count = badge.milestone ? Math.min(memberHikes.length, badge.requirement) : memberHikes.length;
            }
            else if (badge.type === 'distance') { 
              earned = totalDistance >= badge.requirement; 
              count = badge.milestone ? Math.min(Math.floor(totalDistance), badge.requirement) : Math.floor(totalDistance);
            }
            else if (badge.type === 'elevation') { 
              earned = totalElevation >= badge.requirement; 
              count = badge.milestone ? Math.min(Math.floor(totalElevation), badge.requirement) : Math.floor(totalElevation);
            }
            else { count = activityCounts[badge.id] || 0; earned = count > 0; }
            return { ...badge, earned, count };
          });
          
          const earnedBadges = badgeStats.filter(b => b.earned);
          const badgeCategories = {
            'Milestones': badgeStats.filter(b => b.type === 'count' || b.type === 'distance' || b.type === 'elevation'),
            'Wildlife & Creatures': badgeStats.filter(b => ['wildlife','bird','butterfly','frog','squirrel','snake','turtle','rabbit','fish','bee','spider'].includes(b.id)),
            'Nature & Scenery': badgeStats.filter(b => ['waterfall','mushroom','wildflower','treeclimb','pinecone','rock','feather','stream','cave','bridge','sunset','sunrise','rainbow','fog','snow','rain','acorn','leaf','stick','tracks','berries','nest','fossil','crystal','clouds','wind','moon'].includes(b.id)),
            'Locations': badgeStats.filter(b => b.type === 'location'),
            'Activities & Challenges': badgeStats.filter(b => b.type === 'special')
          };
          const selectableActivities = BADGES.filter(b => b.type === 'discovery' || b.type === 'location' || b.type === 'special');

          if (loading) return <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center"><div className="text-2xl text-green-600">Loading...</div></div>;

          if (showSetup) {
            if (setupStep === 'family') {
              return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
                    <div className="text-center mb-6">
                      <Mountain className="w-16 h-16 mx-auto mb-4 text-green-600" />
                      <h1 className="text-3xl font-bold text-green-800 mb-2">Welcome to Hike Together!</h1>
                      <p className="text-gray-600">Create a family or join one</p>
                    </div>
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Create New Family</label>
                        <input type="text" placeholder="Family name" value={newFamilyName} onChange={(e) => setNewFamilyName(e.target.value)} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                        <button onClick={createFamily} className="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Create Family</button>
                      </div>
                      <div className="text-center text-gray-500 font-semibold">OR</div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Join Existing Family</label>
                        <input type="text" placeholder="Enter family code" value={joinCode} onChange={(e) => setJoinCode(e.target.value)} className="w-full p-3 border-2 border-blue-200 rounded-lg focus:border-blue-500 outline-none" />
                        <button onClick={joinFamily} className="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Join Family</button>
                      </div>
                    </div>
                  </div>
                </div>
              );
            } else {
              return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
                    <div className="text-center mb-6">
                      <h2 className="text-3xl font-bold text-green-800 mb-2">Create Your Profile</h2>
                      <p className="text-gray-600">Choose your name and avatar</p>
                    </div>
                    <div className="space-y-4">
                      <input type="text" placeholder="Your name" value={newMemberName} onChange={(e) => setNewMemberName(e.target.value)} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Choose Avatar</label>
                        <div className="grid grid-cols-8 gap-2">
                          {AVATARS.map(avatar => (
                            <button key={avatar} onClick={() => setNewMemberAvatar(avatar)} className={`text-3xl p-2 rounded-lg border-2 ${newMemberAvatar === avatar ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>{avatar}</button>
                          ))}
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Choose Color</label>
                        <div className="grid grid-cols-4 gap-2">
                          {COLORS.map(color => (
                            <button key={color} onClick={() => setNewMemberColor(color)} className={`h-12 rounded-lg border-2 ${newMemberColor === color ? 'border-gray-800 scale-110' : 'border-gray-200'}`} style={{backgroundColor: color}} />
                          ))}
                        </div>
                      </div>
                      <button onClick={createMember} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg mt-6">Start Hiking!</button>
                    </div>
                  </div>
                </div>
              );
            }
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
              {selectedBadge && <BadgeModal badge={selectedBadge} onClose={() => setSelectedBadge(null)} />}
              <div className="max-w-4xl mx-auto">
                <div className="text-center mb-6">
                  <h1 className="text-4xl font-bold text-green-800 mb-2 flex items-center justify-center gap-2"><Mountain />Hike Together</h1>
                  <p className="text-green-600 mb-3">{familyName}</p>
                  
                  {/* Navigation Menu */}
                  <div className="flex gap-3 justify-center mb-4">
                    <button 
                      onClick={() => setCurrentPage('home')} 
                      className={`px-4 py-2 rounded-lg font-semibold transition ${currentPage === 'home' ? 'bg-green-600 text-white' : 'bg-white text-green-600 hover:bg-green-100'}`}
                    >
                      üè† Home
                    </button>
                    <button 
                      onClick={() => setCurrentPage('gear')} 
                      className={`px-4 py-2 rounded-lg font-semibold transition ${currentPage === 'gear' ? 'bg-green-600 text-white' : 'bg-white text-green-600 hover:bg-green-100'}`}
                    >
                      üéí Gear
                    </button>
                    <button 
                      onClick={() => setCurrentPage('about')} 
                      className={`px-4 py-2 rounded-lg font-semibold transition ${currentPage === 'about' ? 'bg-green-600 text-white' : 'bg-white text-green-600 hover:bg-green-100'}`}
                    >
                      ‚ÑπÔ∏è About
                    </button>
                  </div>
                  
                  <div className="flex gap-2 justify-center items-center flex-wrap">
                    {currentMember && (
                      <button onClick={() => setShowMemberMenu(!showMemberMenu)} className="px-4 py-2 rounded-lg shadow-md font-semibold text-white hover:shadow-lg flex items-center gap-2" style={{backgroundColor: currentMember.color}}>
                        <span className="text-2xl">{currentMember.avatar}</span>{currentMember.name}
                      </button>
                    )}
                    <button onClick={copyFamilyCode} className="bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow" title="Share code">üìã Share Code</button>
                  </div>
                  {showMemberMenu && (
                    <div className="mt-4 bg-white rounded-lg shadow-xl p-4 inline-block">
                      <h3 className="font-semibold text-gray-700 mb-3">Switch Profile</h3>
                      <div className="grid grid-cols-2 gap-2">
                        {members.map(member => (
                          <button key={member.id} onClick={() => switchMember(member)} className={`p-3 rounded-lg border-2 flex items-center gap-2 ${currentMember.id === member.id ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>
                            <span className="text-2xl">{member.avatar}</span><span className="font-medium">{member.name}</span>
                          </button>
                        ))}
                      </div>
                      <button onClick={() => { setSetupStep('member'); setShowSetup(true); setShowMemberMenu(false); }} className="w-full mt-3 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2 rounded-lg">+ Add Member</button>
                    </div>
                  )}
                </div>

                {/* HOME PAGE */}
                {currentPage === 'home' && (
                  <>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-8 h-8 mx-auto mb-2 text-green-600"><path d="m8 3 4 8 5-5 5 15H2L8 3z"/></svg>
                    <div className="text-3xl font-bold text-green-800">{memberHikes.length}</div>
                    <div className="text-gray-600 text-sm">Total Hikes</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-8 h-8 mx-auto mb-2 text-blue-600"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    <div className="text-3xl font-bold text-blue-800">{totalDistance.toFixed(1)}</div>
                    <div className="text-gray-600 text-sm">Miles Hiked</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-8 h-8 mx-auto mb-2 text-purple-600"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                    <div className="text-3xl font-bold text-purple-800">{totalElevation.toLocaleString()}</div>
                    <div className="text-gray-600 text-sm">Feet Climbed</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-8 h-8 mx-auto mb-2 text-yellow-600"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>
                    <div className="text-3xl font-bold text-yellow-800">{earnedBadges.length}</div>
                    <div className="text-gray-600 text-sm">Badges Earned</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-8 h-8 mx-auto mb-2 text-orange-600"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    <div className="text-3xl font-bold text-orange-800">{longestHike.toFixed(1)}</div>
                    <div className="text-gray-600 text-sm">Longest Hike (mi)</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-8 h-8 mx-auto mb-2 text-red-600"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                    <div className="text-3xl font-bold text-red-800">{highestElevation.toLocaleString()}</div>
                    <div className="text-gray-600 text-sm">Highest Climb (ft)</div>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-md p-6 mb-8">
                  <div className="flex items-center justify-between mb-6">
                    <h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Award />Achievement Badges ({earnedBadges.length}/{BADGES.length})</h2>
                    <div className="flex gap-2">
                      <button onClick={() => setActiveView('badges')} className={`px-4 py-2 rounded-lg font-semibold ${activeView === 'badges' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                        üèÜ Badges
                      </button>
                      <button onClick={() => setActiveView('map')} className={`px-4 py-2 rounded-lg font-semibold ${activeView === 'map' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                        üó∫Ô∏è Map
                      </button>
                    </div>
                  </div>
                  
                  {activeView === 'badges' && (
                    <>
                  {earnedBadges.length > 0 && (
                    <div className="mb-8">
                      <h3 className="text-xl font-semibold text-green-700 mb-4 pb-2 border-b-2 border-green-200">üéâ Earned Badges</h3>
                      {Object.entries(badgeCategories).map(([category, badges]) => {
                        const earnedInCategory = badges.filter(b => b.earned);
                        if (earnedInCategory.length === 0) return null;
                        return (
                          <div key={category} className="mb-6">
                            <h4 className="text-md font-semibold text-green-600 mb-3">{category}</h4>
                            <div className="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-8 gap-3 pl-4">
                              {earnedInCategory.map(badge => (
                                <div key={badge.id} className="text-center p-3 rounded-lg bg-yellow-50 border-2 border-yellow-400 relative cursor-pointer hover:shadow-lg group" onClick={() => setSelectedBadge(badge)}>
                                  <div className="text-3xl mb-1">{badge.icon}</div>
                                  <div className="font-semibold text-xs leading-tight break-words overflow-hidden" style={{minHeight:'2.5rem'}}>{badge.name}</div>
                                  {badge.count > 0 && !badge.milestone && <div className="absolute -top-2 -right-2 bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">{badge.count}</div>}
                                  <div className="absolute top-1 right-1 bg-green-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100">?</div>
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                  <div>
                    <h3 className="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b-2 border-gray-200">üîí Locked Badges</h3>
                    {Object.entries(badgeCategories).map(([category, badges]) => {
                      const lockedInCategory = badges.filter(b => !b.earned);
                      if (lockedInCategory.length === 0) return null;
                      return (
                        <div key={category} className="mb-6">
                          <h4 className="text-md font-semibold text-gray-600 mb-3">{category}</h4>
                          <div className="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-8 gap-3 pl-4">
                            {lockedInCategory.map(badge => (
                              <div key={badge.id} className="text-center p-3 rounded-lg bg-gray-50 border-2 border-gray-200 opacity-50 relative cursor-pointer hover:opacity-70 group" onClick={() => setSelectedBadge(badge)}>
                                <div className="text-3xl mb-1">{badge.icon}</div>
                                <div className="font-semibold text-xs leading-tight break-words overflow-hidden" style={{minHeight:'2.5rem'}}>{badge.name}</div>
                                <div className="absolute top-1 right-1 bg-gray-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100">?</div>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  </>
                  )}
                  
                  {activeView === 'map' && (
                    <MapComponent hikes={memberHikes} currentMember={currentMember} />
                  )}
                </div>

                <button onClick={() => { setShowForm(!showForm); setEditingHike(null); setFormData({ name: '', date: new Date().toISOString().split('T')[0], distance: '', elevation: '', difficulty: 'easy', location: '', notes: '', activities: [] }); }} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg mb-6 flex items-center justify-center gap-2"><Plus />Add New Hike</button>

                {showForm && (
                  <div className="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 className="text-2xl font-bold text-green-800 mb-4">{editingHike ? 'Edit Hike' : 'Record Your Adventure'}</h2>
                    <div className="space-y-4">
                      <input type="text" placeholder="Hike Name" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                      <input type="date" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                      <select value={formData.difficulty} onChange={(e) => setFormData({...formData, difficulty: e.target.value})} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none">
                        <option value="easy">Easy üü¢</option>
                        <option value="medium">Medium üü°</option>
                        <option value="hard">Hard üî¥</option>
                      </select>
                      <input type="number" step="0.1" placeholder="Distance (miles)" value={formData.distance} onChange={(e) => setFormData({...formData, distance: e.target.value})} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                      <input type="number" placeholder="Elevation (feet)" value={formData.elevation} onChange={(e) => setFormData({...formData, elevation: e.target.value})} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                      <input type="text" placeholder="Location" value={formData.location} onChange={(e) => setFormData({...formData, location: e.target.value})} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                      <textarea placeholder="Notes" value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none h-24" />
                      <div className="border-2 border-green-200 rounded-lg p-4">
                        <h3 className="font-semibold text-green-800 mb-2">üèÜ What did you do/see?</h3>
                        {[
                          {title:'Wildlife & Creatures',ids:['wildlife','bird','butterfly','frog','squirrel','snake','turtle','rabbit','fish','bee','spider']},
                          {title:'Nature & Scenery',ids:['waterfall','mushroom','wildflower','treeclimb','pinecone','rock','feather','stream','cave','bridge','sunset','sunrise','rainbow','fog','snow','rain','acorn','leaf','stick','tracks','berries','nest','fossil','crystal','clouds','wind','moon']},
                          {title:'Locations',type:'location'},
                          {title:'Activities',type:'special'}
                        ].map(section => (
                          <div key={section.title} className="mb-4">
                            <h4 className="text-xs font-semibold text-gray-600 mb-2">{section.title}</h4>
                            <div className="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                              {selectableActivities.filter(b => section.type ? b.type === section.type : section.ids.includes(b.id)).map(badge => {
                                const selected = formData.activities.includes(badge.id);
                                return (
                                  <button key={badge.id} type="button" onClick={() => toggleActivity(badge.id)} className={`p-2 rounded-lg border-2 ${selected ? 'bg-yellow-50 border-yellow-400 scale-105' : 'bg-white border-gray-200'}`} title={badge.desc}>
                                    <div className="text-2xl mb-1">{badge.icon}</div>
                                    <div className="text-xs font-medium leading-tight" style={{minHeight:'2rem'}}>{badge.name}</div>
                                  </button>
                                );
                              })}
                            </div>
                          </div>
                        ))}
                      </div>
                      {geocodingStatus && (
                        <div className="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-2 rounded-lg text-sm">
                          {geocodingStatus}
                        </div>
                      )}
                      <div className="flex gap-2">
                        <button onClick={saveHike} disabled={!!geocodingStatus} className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">{editingHike ? 'Update Hike' : 'Save Hike'}</button>
                        <button onClick={() => { setShowForm(false); setEditingHike(null); setFormData({ name: '', date: new Date().toISOString().split('T')[0], distance: '', elevation: '', difficulty: 'easy', location: '', notes: '', activities: [] }); }} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg">Cancel</button>
                      </div>
                    </div>
                  </div>
                )}

                <div className="space-y-4">
                  <h2 className="text-2xl font-bold text-green-800">Your Hikes</h2>
                  {memberHikes.length === 0 ? (
                    <div className="bg-white rounded-lg shadow-md p-8 text-center text-gray-500">
                      <Mountain className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                      <p className="text-xl">No hikes yet!</p>
                    </div>
                  ) : (
                    memberHikes.map(hike => (
                      <div key={hike.id} className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex justify-between items-start mb-3">
                          <div>
                            <div className="flex items-center gap-2 mb-1">
                              <span className="text-2xl">{hike.hikerAvatar}</span>
                              <h3 className="text-xl font-bold text-green-800">{hike.name}</h3>
                              {hike.difficulty && (
                                <span className={`text-xs px-2 py-1 rounded-full font-bold ${hike.difficulty === 'easy' ? 'bg-green-100 text-green-800' : hike.difficulty === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>
                                  {hike.difficulty === 'easy' ? 'üü¢ Easy' : hike.difficulty === 'medium' ? 'üü° Medium' : 'üî¥ Hard'}
                                </span>
                              )}
                            </div>
                            <div className="flex items-center gap-4 text-gray-600 text-sm">
                              <span className="flex items-center gap-1"><Calendar />{new Date(hike.date).toLocaleDateString()}</span>
                              {hike.location && <span className="flex items-center gap-1"><MapPin />{hike.location}</span>}
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <button onClick={() => editHike(hike)} className="text-blue-500 hover:text-blue-700 text-sm font-semibold">Edit</button>
                            <button onClick={() => deleteHike(hike.id)} className="text-red-500 hover:text-red-700 text-sm font-semibold">Delete</button>
                          </div>
                        </div>
                        <div className="flex gap-4 mb-3">
                          <div className="bg-blue-50 px-4 py-2 rounded-lg">
                            <div className="text-blue-800 font-bold">{hike.distance} mi</div>
                            <div className="text-blue-600 text-sm">Distance</div>
                          </div>
                          {hike.elevation > 0 && (
                            <div className="bg-purple-50 px-4 py-2 rounded-lg">
                              <div className="text-purple-800 font-bold">{hike.elevation} ft</div>
                              <div className="text-purple-600 text-sm">Elevation</div>
                            </div>
                          )}
                        </div>
                        {hike.notes && <p className="text-gray-700 bg-gray-50 p-3 rounded-lg mb-3">{hike.notes}</p>}
                        {hike.activities && hike.activities.length > 0 && (
                          <div className="mt-3">
                            <div className="text-sm font-semibold text-gray-700 mb-2">Badges Earned:</div>
                            <div className="flex flex-wrap gap-2">
                              {hike.activities.map(activityId => {
                                const badge = BADGES.find(b => b.id === activityId);
                                return badge ? (
                                  <div key={activityId} className="bg-yellow-50 border-2 border-yellow-400 rounded-lg px-3 py-1 flex items-center gap-2">
                                    <span className="text-xl">{badge.icon}</span>
                                    <span className="text-sm font-medium">{badge.name}</span>
                                  </div>
                                ) : null;
                              })}
                            </div>
                          </div>
                        )}
                      </div>
                    ))
                  )}
                </div>
                </>
                )}

                {/* GEAR PAGE */}
                {currentPage === 'gear' && (
                  <div className="bg-white rounded-lg shadow-md p-8 max-w-3xl mx-auto">
                    <h2 className="text-3xl font-bold text-green-800 mb-6">üéí Recommended Hiking Gear for Families</h2>
                    
                    {/* EDIT THIS SECTION - Add or modify gear recommendations below */}
                    <div className="space-y-6">
                      
                      {/* Gear Item 1 */}
                      <div className="border-l-4 border-green-500 pl-4 py-2">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">Kids' Hiking Backpack</h3>
                        <p className="text-gray-600 mb-2">A properly sized backpack helps kids carry their own water, snacks, and treasures found on the trail. Look for adjustable straps and fun colors.</p>
                        <p className="text-sm text-blue-600">üí° Recommended: Deuter Kikki or Osprey Jet 12</p>
                      </div>

                      {/* Gear Item 2 */}
                      <div className="border-l-4 border-blue-500 pl-4 py-2">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">Trail Snacks & Water</h3>
                        <p className="text-gray-600 mb-2">Keep energy high with healthy snacks like trail mix, fruit, and granola bars. Reusable water bottles or hydration packs keep everyone hydrated.</p>
                        <p className="text-sm text-blue-600">üí° Tip: Pack more snacks than you think you'll need!</p>
                      </div>

                      {/* Gear Item 3 */}
                      <div className="border-l-4 border-purple-500 pl-4 py-2">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">Proper Footwear</h3>
                        <p className="text-gray-600 mb-2">Good hiking shoes or boots with ankle support and grip are essential. Break them in before hitting the trails!</p>
                        <p className="text-sm text-blue-600">üí° Recommended: Merrell or Keen kids' hiking boots</p>
                      </div>

                      {/* Gear Item 4 */}
                      <div className="border-l-4 border-orange-500 pl-4 py-2">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">First Aid Kit</h3>
                        <p className="text-gray-600 mb-2">A compact first aid kit with bandages, antiseptic wipes, and blister treatment is a must-have for family hikes.</p>
                        <p className="text-sm text-blue-600">üí° Don't forget: Sunscreen and insect repellent</p>
                      </div>

                      {/* Gear Item 5 */}
                      <div className="border-l-4 border-red-500 pl-4 py-2">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">Nature Exploration Tools</h3>
                        <p className="text-gray-600 mb-2">Binoculars, magnifying glasses, and field guides make hiking educational and exciting for curious kids.</p>
                        <p className="text-sm text-blue-600">üí° Bonus: Add a nature journal for drawing discoveries!</p>
                      </div>

                      {/* ADD MORE GEAR ITEMS HERE - Copy the structure above */}
                      
                    </div>
                    
                    <div className="mt-8 p-4 bg-green-50 rounded-lg">
                      <p className="text-sm text-gray-600 italic">
                        üíö Happy hiking! Remember, the best gear is the gear that gets you outside together as a family.
                      </p>
                    </div>
                  </div>
                )}

                {/* ABOUT PAGE */}
                {currentPage === 'about' && (
                  <div className="bg-white rounded-lg shadow-md p-8 max-w-3xl mx-auto">
                    <h2 className="text-3xl font-bold text-green-800 mb-6">‚ÑπÔ∏è About Hike Together</h2>
                    
                    {/* EDIT THIS SECTION - Customize the about content below */}
                    <div className="space-y-4 text-gray-700 leading-relaxed">
                      
                      <p className="text-lg">
                        <strong>Hike Together</strong> is a family hiking tracker designed to make outdoor adventures more fun, memorable, and rewarding for families with kids.
                      </p>

                      <h3 className="text-xl font-bold text-green-700 mt-6 mb-3">üå≤ Our Mission</h3>
                      <p>
                        We believe that time spent in nature as a family creates lasting memories and fosters a love for the outdoors in children. Hike Together helps families track their adventures, celebrate milestones, and discover new trails together.
                      </p>

                      <h3 className="text-xl font-bold text-green-700 mt-6 mb-3">‚ú® Features</h3>
                      <ul className="list-disc list-inside space-y-2 ml-4">
                        <li>Track every family member's hikes individually</li>
                        <li>Record distance, elevation, and difficulty</li>
                        <li>Map your hiking locations</li>
                        <li>Earn achievement badges for milestones and discoveries</li>
                        <li>Log wildlife sightings, trail features, and special moments</li>
                        <li>Build a digital scrapbook of your family's hiking journey</li>
                      </ul>

                      <h3 className="text-xl font-bold text-green-700 mt-6 mb-3">ü•æ Why Track Your Hikes?</h3>
                      <p>
                        Tracking your family's hikes turns each adventure into an achievement. Kids love collecting badges, seeing their progress on the map, and competing (friendly, of course!) to reach new milestones. It motivates everyone to get outside more often and explore new trails.
                      </p>

                      <h3 className="text-xl font-bold text-green-700 mt-6 mb-3">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Perfect for Families</h3>
                      <p>
                        Whether you're taking your first nature walk with a toddler or summiting peaks with teenagers, Hike Together grows with your family. Every hike‚Äîno matter how short‚Äîcounts toward your family's journey.
                      </p>

                      {/* ADD MORE SECTIONS HERE */}

                    </div>

                    <div className="mt-8 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border-2 border-green-200">
                      <p className="text-center text-green-800 font-semibold">
                        üèîÔ∏è Start your family's hiking adventure today!
                      </p>
                    </div>
                  </div>
                )}

              </div>
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
