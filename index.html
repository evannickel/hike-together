const createMember = async () => {
            if (!newMemberName.trim()) return;
            try {
              const memberRef = await db.collection('families').doc(familyId).collection('members').add({
                name: newMemberName,
                avatar: newMemberAvatar,
                color: newMemberColor,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              const newMember = { id: memberRef.id, name: newMemberName, avatar: newMemberAvatar, color: newMemberColor };
              setMembers([...members, newMember]);
              setCurrentMember(newMember);
              localStorage.setItem('currentMemberId', memberRef.id);
              setShowSetup(false);
              setNewMemberName('');
            } catch (error) {
              alert('Error creating member: ' + error.message);
            }
          };

          const switchMember = (member) => {
            setCurrentMember(member);
            localStorage.setItem('currentMemberId', member.id);
            setShowMemberMenu(false);
          };

          const saveHike = async () => {
            if (!formData.name || !formData.distance || !currentMember) return;
            try {
              await db.collection('families').doc(familyId).collection('hikes').add({
                name: formData.name,
                date: formData.date,
                distance: parseFloat(formData.distance),
                elevation: parseFloat(formData.elevation) || 0,
                location: formData.location,
                notes: formData.notes,
                activities: formData.activities,
                hikerId: currentMember.id,
                hikerName: currentMember.name,
                hikerAvatar: currentMember.avatar,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              setFormData({
                name: '',
                date: new Date().toISOString().split('T')[0],
                distance: '',
                elevation: '',
                location: '',
                notes: '',
                activities: []
              });
              setShowForm(false);
            } catch (error) {
              alert('Error saving hike: ' + error.message);
            }
          };

          const deleteHike = async (id) => {
            try {
              await db.collection('families').doc(familyId).collection('hikes').doc(id).delete();
            } catch (error) {
              alert('Error deleting hike: ' + error.message);
            }
          };

          const toggleActivity = (activityId) => {
            const newActivities = formData.activities.includes(activityId)
              ? formData.activities.filter(id => id !== activityId)
              : [...formData.activities, activityId];
            setFormData({ ...formData, activities: newActivities });
          };

          const copyFamilyCode = () => {
            navigator.clipboard.writeText(familyId);
            alert('Family code copied! Share it with family members to join.');
          };

          const memberHikes = hikes.filter(h => !currentMember || h.hikerId === currentMember.id);
          const totalDistance = memberHikes.reduce((sum, h) => sum + h.distance, 0);
          const totalElevation = memberHikes.reduce((sum, h) => sum + h.elevation, 0);
          
          const activityCounts = {};
          memberHikes.forEach(hike => {
            if (hike.activities) {
              hike.activities.forEach(activityId => {
                activityCounts[activityId] = (activityCounts[activityId] || 0) + 1;
              });
            }
          });
          
          const badgeStats = BADGES.map(badge => {
            let earned = false;
            let count = 0;
            
            if (badge.type === 'count') {
              earned = memberHikes.length >= badge.requirement;
              count = memberHikes.length;
            } else if (badge.type === 'distance') {
              earned = totalDistance >= badge.requirement;
              count = Math.floor(totalDistance);
            } else if (badge.type === 'elevation') {
              earned = totalElevation >= badge.requirement;
              count = Math.floor(totalElevation);
            } else {
              count = activityCounts[badge.id] || 0;
              earned = count > 0;
            }
            
            return { ...badge, earned, count };
          });
          
          const earnedBadges = badgeStats.filter(b => b.earned);
          
          const badgeCategories = {
            'Milestones': badgeStats.filter(b => b.type === 'count' || b.type === 'distance' || b.type === 'elevation'),
            'Wildlife & Creatures': badgeStats.filter(b => ['wildlife', 'bird', 'butterfly', 'frog', 'squirrel', 'snake', 'turtle', 'rabbit', 'fish', 'bee', 'spider'].includes(b.id)),
            'Nature & Scenery': badgeStats.filter(b => ['waterfall', 'mushroom', 'wildflower', 'treeclimb', 'pinecone', 'rock', 'feather', 'stream', 'cave', 'bridge', 'sunset', 'sunrise', 'rainbow', 'fog', 'snow', 'rain', 'acorn', 'leaf', 'stick', 'tracks', 'berries', 'nest', 'fossil', 'crystal', 'clouds', 'wind', 'moon'].includes(b.id)),
            'Locations': badgeStats.filter(b => b.type === 'location'),
            'Activities & Challenges': badgeStats.filter(b => b.type === 'special')
          };
          
          const selectableActivities = BADGES.filter(b => 
            b.type === 'discovery' || b.type === 'location' || b.type === 'special'
          );

          if (loading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center">
                <div className="text-2xl text-green-600">Loading...</div>
              </div>
            );
          }

          if (showSetup) {
            if (setupStep === 'family') {
              return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
                    <div className="text-center mb-6">
                      <Mountain className="w-16 h-16 mx-auto mb-4 text-green-600" />
                      <h1 className="text-3xl font-bold text-green-800 mb-2">Welcome to Hike Together!</h1>
                      <p className="text-gray-600">Create a family or join an existing one</p>
                    </div>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Create New Family</label>
                        <input
                          type="text"
                          placeholder="Family name (e.g., The Smiths)"
                          value={newFamilyName}
                          onChange={(e) => setNewFamilyName(e.target.value)}
                          className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none"
                        />
                        <button
                          onClick={createFamily}
                          className="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition"
                        >
                          Create Family
                        </button>
                      </div>

                      <div className="text-center text-gray-500 font-semibold">OR</div>

                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Join Existing Family</label>
                        <input
                          type="text"
                          placeholder="Enter family code"
                          value={joinCode}
                          onChange={(e) => setJoinCode(e.target.value)}
                          className="w-full p-3 border-2 border-blue-200 rounded-lg focus:border-blue-500 outline-none"
                        />
                        <button
                          onClick={joinFamily}
                          className="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition"
                        >
                          Join Family
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              );
            } else {
              return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
                    <div className="text-center mb-6">
                      <h2 className="text-3xl font-bold text-green-800 mb-2">Create Your Profile</h2>
                      <p className="text-gray-600">Choose your name and avatar</p>
                    </div>
                    
                    <div className="space-y-4">
                      <input
                        type="text"
                        placeholder="Your name"
                        value={newMemberName}
                        onChange={(e) => setNewMemberName(e.target.value)}
                        className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none"
                      />
                      
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Choose Avatar</label>
                        <div className="grid grid-cols-8 gap-2">
                          {AVATARS.map(avatar => (
                            <button
                              key={avatar}
                              onClick={() => setNewMemberAvatar(avatar)}
                              className={`text-3xl p-2 rounded-lg border-2 transition ${
                                newMemberAvatar === avatar ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-green-300'
                              }`}
                            >
                              {avatar}
                            </button>
                          ))}
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Choose Color</label>
                        <div className="grid grid-cols-5 gap-2">
                          {COLORS.map(color => (
                            <button
                              key={color}
                              onClick={() => setNewMemberColor(color)}
                              className={`h-12 rounded-lg border-2 transition ${
                                newMemberColor === color ? 'border-gray-800 scale-110' : 'border-gray-200'
                              }`}
                              style={{ backgroundColor: color }}
                            />
                          ))}
                        </div>
                      </div>

                      <button
                        onClick={createMember}
                        className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition mt-6"
                      >
                        Start Hiking!
                      </button>
                    </div>
                  </div>
                </div>
              );
            }
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
              {selectedBadge && <BadgeModal badge={selectedBadge} onClose={() => setSelectedBadge(null)} />}
              
              <div className="max-w-4xl mx-auto">
                <div className="text-center mb-6">
                  <h1 className="text-4xl font-bold text-green-800 mb-2 flex items-center justify-center gap-2">
                    <Mountain />
                    Hike Together
                  </h1>
                  <p className="text-green-600 mb-3">{familyName}</p>
                  
                  <div className="flex gap-2 justify-center items-center flex-wrap">
                    {currentMember && (
                      <button
                        onClick={() => setShowMemberMenu(!showMemberMenu)}
                        className="px-4 py-2 rounded-lg shadow-md font-semibold text-white transition hover:shadow-lg flex items-center gap-2"
                        style={{ backgroundColor: currentMember.color }}
                      >
                        <span className="text-2xl">{currentMember.avatar}</span>
                        {currentMember.name}
                      </button>
                    )}
                    
                    <button
                      onClick={copyFamilyCode}
                      className="bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow transition flex items-center gap-2"
                      title="Share family code"
                    >
                      <Copy />
                      Share Code
                    </button>
                  </div>

                  {showMemberMenu && (
                    <div className="mt-4 bg-white rounded-lg shadow-xl p-4 inline-block">
                      <h3 className="font-semibold text-gray-700 mb-3">Switch Profile</h3>
                      <div className="grid grid-cols-2 gap-2">
                        {members.map(member => (
                          <button
                            key={member.id}
                            onClick={() => switchMember(member)}
                            className={`p-3 rounded-lg border-2 transition flex items-center gap-2 ${
                              currentMember.id === member.id ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-gray-300'
                            }`}
                          >
                            <span className="text-2xl">{member.avatar}</span>
                            <span className="font-medium">{member.name}</span>
                          </button>
                        ))}
                      </div>
                      <button
                        onClick={() => { setSetupStep('member'); setShowSetup(true); setShowMemberMenu(false); }}
                        className="w-full mt-3 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2 rounded-lg transition"
                      >
                        + Add Family Member
                      </button>
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-8 h-8 mx-auto mb-2 text-green-600">
                      <path d="m8 3 4 8 5-5 5 15H2L8 3z"/>
                    </svg>
                    <div className="text-3xl font-bold text-green-800">{memberHikes.length}</div>
                    <div className="text-gray-600 text-sm">Total Hikes</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-8 h-8 mx-auto mb-2 text-blue-600">
                      <path d="M5 12h14"/>
                      <path d="m12 5 7 7-7 7"/>
                    </svg>
                    <div className="text-3xl font-bold text-blue-800">{totalDistance.toFixed(1)}</div>
                    <div className="text-gray-600 text-sm">Miles Hiked</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-8 h-8 mx-auto mb-2 text-purple-600">
                      <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/>
                      <polyline points="16 7 22 7 22 13"/>
                    </svg>
                    <div className="text-3xl font-bold text-purple-800">{totalElevation.toLocaleString()}</div>
                    <div className="text-gray-600 text-sm">Feet Climbed</div>
                  </div>
                  <div className="bg-white rounded-lg shadow-md p-6 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-8 h-8 mx-auto mb-2 text-yellow-600">
                      <circle cx="12" cy="8" r="6"/>
                      <path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/>
                    </svg>
                    <div className="text-3xl font-bold text-yellow-800">{earnedBadges.length}</div>
                    <div className="text-gray-600 text-sm">Badges Earned</div>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-md p-6 mb-8">
                  <h2 className="text-2xl font-bold text-green-800 mb-6 flex items-center gap-2">
                    <Award />
                    Achievement Badges ({earnedBadges.length}/{BADGES.length})
                  </h2>
                  
                  {earnedBadges.length > 0 && (
                    <div className="mb-8">
                      <h3 className="text-xl font-semibold text-green-700 mb-4 pb-2 border-b-2 border-green-200">ğŸ‰ Earned Badges</h3>
                      
                      {Object.entries(badgeCategories).map(([category, badges]) => {
                        const earnedInCategory = badges.filter(b => b.earned);
                        if (earnedInCategory.length === 0) return null;
                        
                        return (
                          <div key={category} className="mb-6">
                            <h4 className="text-md font-semibold text-green-600 mb-3">{category}</h4>
                            <div className="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-8 gap-3 pl-4">
                              {earnedInCategory.map(badge => (
                                <div
                                  key={badge.id}
                                  className="text-center p-3 rounded-lg bg-yellow-50 border-2 border-yellow-400 relative cursor-pointer hover:shadow-lg transition group"
                                  onClick={() => setSelectedBadge(badge)}
                                >
                                  <div className="text-3xl mb-1">{badge.icon}</div>
                                  <div className="font-semibold text-xs leading-tight break-words overflow-hidden" style={{minHeight: '2.5rem'}}>{badge.name}</div>
                                  {badge.count > 0 && badge.type !== 'count' && (
                                    <div className="absolute -top-2 -right-2 bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">
                                      {badge.count}
                                    </div>
                                  )}
                                  <div className="absolute top-1 right-1 bg-green-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">?</div>
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                  
                  <div>
                    <h3 className="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b-2 border-gray-200">ğŸ”’ Locked Badges</h3>
                    
                    {Object.entries(badgeCategories).map(([category, badges]) => {
                      const lockedInCategory = badges.filter(b => !b.earned);
                      if (lockedInCategory.length === 0) return null;
                      
                      return (
                        <div key={category} className="mb-6">
                          <h4 className="text-md font-semibold text-gray-600 mb-3">{category}</h4>
                          <div className="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-8 gap-3 pl-4">
                            {lockedInCategory.map(badge => (
                              <div
                                key={badge.id}
                                className="text-center p-3 rounded-lg bg-gray-50 border-2 border-gray-200 opacity-50 relative cursor-pointer hover:opacity-70 transition group"
                                onClick={() => setSelectedBadge(badge)}
                              >
                                <div className="text-3xl mb-1">{badge.icon}</div>
                                <div className="font-semibold text-xs leading-tight break-words overflow-hidden" style={{minHeight: '2.5rem'}}>{badge.name}</div>
                                <div className="absolute top-1 right-1 bg-gray-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">?</div>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                <button
                  onClick={() => setShowForm(!showForm)}
                  className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg mb-6 flex items-center justify-center gap-2 transition"
                >
                  <Plus />
                  Add New Hike
                </button>

                {showForm && (
                  <div className="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 className="text-2xl font-bold text-green-800 mb-4">Record Your Adventure</h2>
                    <div className="space-y-4">
                      <input type="text" placeholder="Hike Name" value={formData.name} onChange={(e) => setFormData({ ...formData, name: e.target.value })} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                      <input type="date" value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                      <input type="number" step="0.1" placeholder="Distance (miles)" value={formData.distance} onChange={(e) => setFormData({ ...formData, distance: e.target.value })} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                      <input type="number" placeholder="Elevation Gain (feet, optional)" value={formData.elevation} onChange={(e) => setFormData({ ...formData, elevation: e.target.value })} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                      <input type="text" placeholder="Location (optional)" value={formData.location} onChange={(e) => setFormData({ ...formData, location: e.target.value })} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none" />
                      <textarea placeholder="Notes" value={formData.notes} onChange={(e) => setFormData({ ...formData, notes: e.target.value })} className="w-full p-3 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none h-24" />
                      
                      <div className="border-2 border-green-200 rounded-lg p-4">
                        <h3 className="font-semibold text-green-800 mb-2">ğŸ† What did you do/see?</h3>
                        <p className="text-sm text-gray-600 mb-3">Select everything you experienced!</p>
                        
                        {[
                          { title: 'Wildlife & Creatures', ids: ['wildlife', 'bird', 'butterfly', 'frog', 'squirrel', 'snake', 'turtle', 'rabbit', 'fish', 'bee', 'spider'] },
                          { title: 'Nature & Scenery', ids: ['waterfall', 'mushroom', 'wildflower', 'treeclimb', 'pinecone', 'rock', 'feather', 'stream', 'cave', 'bridge', 'sunset', 'sunrise', 'rainbow', 'fog', 'snow', 'rain', 'acorn', 'leaf', 'stick', 'tracks', 'berries', 'nest', 'fossil', 'crystal', 'clouds', 'wind', 'moon'] },
                          { title: 'Locations', type: 'location' },
                          { title: 'Activities & Challenges', type: 'special' }
                        ].map(section => (
                          <div key={section.title} className="mb-4">
                            <h4 className="text-xs font-semibold text-gray-600 mb-2">{section.title}</h4>
                            <div className="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                              {selectableActivities.filter(b => section.type ? b.type === section.type : section.ids.includes(b.id)).map(badge => {
                                const selected = formData.activities.includes(badge.id);
                                return (
                                  <button
                                    key={badge.id}
                                    type="button"
                                    onClick={() => toggleActivity(badge.id)}
                                    className={`p-2 rounded-lg border-2 transition transform ${selected ? 'bg-yellow-50 border-yellow-400 scale-105 shadow-md' : 'bg-white border-gray-200 hover:border-green-300 hover:shadow'}`}
                                    title={badge.desc}
                                  >
                                    <div className="text-2xl mb-1">{badge.icon}</div>
                                    <div className="text-xs font-medium leading-tight break-words" style={{minHeight: '2rem'}}>{badge.name}</div>
                                  </button>
                                );
                              })}
                            </div>
                          </div>
                        ))}
                      </div>
                      
                      <div className="flex gap-2">
                        <button onClick={saveHike} className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">Save Hike</button>
                        <button onClick={() => setShowForm(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition">Cancel</button>
                      </div>
                    </div>
                  </div>
                )}

                <div className="space-y-4">
                  <h2 className="text-2xl font-bold text-green-800 mb-4">Hiking Journey</h2>
                  {memberHikes.length === 0 ? (
                    <div className="bg-white rounded-lg shadow-md p-8 text-center text-gray-500">
                      <Mountain className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                      <p className="text-xl">No hikes yet!</p>
                      <p className="mt-2">Add your first hike above.</p>
                    </div>
                  ) : (
                    memberHikes.map(hike => (
                      <div key={hike.id} className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex justify-between items-start mb-3">
                          <div>
                            <div className="flex items-center gap-2 mb-1">
                              <span className="text-2xl">{hike.hikerAvatar}</span>
                              <h3 className="text-xl font-bold text-green-800">{hike.name}</h3>
                            </div>
                            <div className="flex items-center gap-4 text-gray-600 text-sm">
                              <span className="flex items-center gap-1">
                                <Calendar />
                                {new Date(hike.date).toLocaleDateString()}
                              </span>
                              {hike.location && (
                                <span className="flex items-center gap-1">
                                  <MapPin />
                                  {hike.location}
                                </span>
                              )}
                            </div>
                          </div>
                          <button onClick={() => deleteHike(hike.id)} className="text-red-500 hover:text-red-700 text-sm">Delete</button>
                        </div>
                        <div className="flex gap-4 mb-3">
                          <div className="bg-blue-50 px-4 py-2 rounded-lg">
                            <div className="text-blue-800 font-bold">{hike.distance} mi</div>
                            <div className="text-blue-600 text-sm">Distance</div>
                          </div>
                          {hike.elevation > 0 && (
                            <div className="bg-purple-50 px-4 py-2 rounded-lg">
                              <div className="text-purple-800 font-bold">{hike.elevation} ft</div>
                              <div className="text-purple-600 text-sm">Elevation</div>
                            </div>
                          )}
                        </div>
                        {hike.notes && <p className="text-gray-700 bg-gray-50 p-3 rounded-lg mb-3">{hike.notes}</p>}
                        {hike.activities && hike.activities.length > 0 && (
                          <div className="mt-3">
                            <div className="text-sm font-semibold text-gray-700 mb-2">Badges Earned:</div>
                            <div className="flex flex-wrap gap-2">
                              {hike.activities.map(activityId => {
                                const badge = BADGES.find(b => b.id === activityId);
                                return badge ? (
                                  <div key={activityId} className="bg-yellow-50 border-2 border-yellow-400 rounded-lg px-3 py-1 flex items-center gap-2">
                                    <span className="text-xl">{badge.icon}</span>
                                    <span className="text-sm font-medium">{badge.name}</span>
                                  </div>
                                ) : null;
                              })}
                            </div>
                          </div>
                        )}
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hike Together</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
     const firebaseConfig = {
  apiKey: "AIzaSyDS6292P80pBlZ-rMVOAEwHfFEGo9RDDrk",
  authDomain: "hike-together-app.firebaseapp.com",
  projectId: "hike-together-app",
  storageBucket: "hike-together-app.firebasestorage.app",
  messagingSenderId: "773950556723",
  appId: "1:773950556723:web:36b9faae2ec3ceaeaa7146",
  measurementId: "G-WXFDKVVEER"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const { useState, useEffect } = React;

        const AVATARS = ['ğŸ‘¨', 'ğŸ‘©', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ§’', 'ğŸ‘¶', 'ğŸ§‘', 'ğŸ‘´', 'ğŸ‘µ', 'ğŸ¶', 'ğŸ±', 'ğŸ»', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ¯', 'ğŸ¦„', 'ğŸ¼', 'ğŸ¨', 'ğŸ¸', 'ğŸ¦‹'];
        const COLORS = ['#4CAF50', '#2196F3', '#FF9800', '#E91E63', '#9C27B0', '#00BCD4', '#FF5722', '#795548', '#607D8B', '#3F51B5'];

        const Mountain = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m8 3 4 8 5-5 5 15H2L8 3z"/></svg>;
        const Award = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>;
        const Calendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
        const MapPin = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
        const Plus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const Users = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const Copy = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;

        const BadgeModal = ({ badge, onClose }) => {
          if (!badge) return null;
          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
              <div className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl" onClick={(e) => e.stopPropagation()}>
                <div className="text-center">
                  <div className="text-6xl mb-4">{badge.icon}</div>
                  <h3 className="text-2xl font-bold text-green-800 mb-2">{badge.name}</h3>
                  <p className="text-gray-600 mb-4">{badge.desc}</p>
                  {badge.requirement && (
                    <div className="bg-green-50 rounded-lg p-3 mb-4">
                      <p className="text-sm font-semibold text-green-800">
                        Requirement: {badge.requirement} {badge.type === 'count' ? 'hikes' : badge.type === 'distance' ? 'miles' : 'feet'}
                      </p>
                    </div>
                  )}
                  {badge.earned && badge.count > 0 && (
                    <div className="bg-yellow-50 rounded-lg p-3 mb-4">
                      <p className="text-sm font-semibold text-yellow-800">âœ¨ Achieved {badge.count} time{badge.count !== 1 ? 's' : ''}!</p>
                    </div>
                  )}
                  <button onClick={onClose} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">Close</button>
                </div>
              </div>
            </div>
          );
        };

        const BADGES = [
          { id: 'first', name: 'First Steps', icon: 'ğŸ¥¾', type: 'count', requirement: 1, desc: 'Complete your first hike' },
          { id: 'explorer', name: 'Explorer', icon: 'ğŸ—ºï¸', type: 'count', requirement: 5, desc: 'Complete 5 hikes' },
          { id: 'adventurer', name: 'Adventurer', icon: 'â›°ï¸', type: 'count', requirement: 10, desc: 'Complete 10 hikes' },
          { id: 'trailblazer', name: 'Trailblazer', icon: 'ğŸ”¥', type: 'count', requirement: 25, desc: 'Complete 25 hikes' },
          { id: 'legend', name: 'Hiking Legend', icon: 'ğŸ‘‘', type: 'count', requirement: 50, desc: 'Complete 50 hikes' },
          { id: 'century', name: 'Century Club', icon: 'ğŸ’¯', type: 'count', requirement: 100, desc: 'Complete 100 hikes' },
          { id: 'distance10', name: 'First 10', icon: 'ğŸƒ', type: 'distance', requirement: 10, desc: 'Hike 10 total miles' },
          { id: 'distance25', name: 'Quarter Century', icon: 'ğŸš¶', type: 'distance', requirement: 25, desc: 'Hike 25 total miles' },
          { id: 'distance50', name: 'Half Century', icon: 'ğŸ¥‡', type: 'distance', requirement: 50, desc: 'Hike 50 total miles' },
          { id: 'distance100', name: 'Centurion', icon: 'â­', type: 'distance', requirement: 100, desc: 'Hike 100 total miles' },
          { id: 'distance250', name: 'Ultra Hiker', icon: 'ğŸ’ª', type: 'distance', requirement: 250, desc: 'Hike 250 total miles' },
          { id: 'distance500', name: 'Marathon Master', icon: 'ğŸ†', type: 'distance', requirement: 500, desc: 'Hike 500 total miles' },
          { id: 'climber1k', name: 'Hill Climber', icon: 'ğŸ§—', type: 'elevation', requirement: 1000, desc: 'Climb 1,000 feet total' },
          { id: 'climber5k', name: 'Peak Climber', icon: 'ğŸ”ï¸', type: 'elevation', requirement: 5000, desc: 'Climb 5,000 feet total' },
          { id: 'climber10k', name: 'Mountain Goat', icon: 'ğŸ', type: 'elevation', requirement: 10000, desc: 'Climb 10,000 feet total' },
          { id: 'climber25k', name: 'Everest Base', icon: 'ğŸ—»', type: 'elevation', requirement: 25000, desc: 'Climb 25,000 feet total' },
          { id: 'climber50k', name: 'Sky Walker', icon: 'â˜ï¸', type: 'elevation', requirement: 50000, desc: 'Climb 50,000 feet total' },
          { id: 'climber100k', name: 'Altitude King', icon: 'ğŸ‘‘', type: 'elevation', requirement: 100000, desc: 'Climb 100,000 feet total' },
          { id: 'waterfall', name: 'Waterfall Finder', icon: 'ğŸ’¦', type: 'discovery', desc: 'Find a waterfall' },
          { id: 'wildlife', name: 'Wildlife Spotter', icon: 'ğŸ¦Œ', type: 'discovery', desc: 'See a wild animal' },
          { id: 'bird', name: 'Bird Watcher', icon: 'ğŸ¦…', type: 'discovery', desc: 'Spot a bird' },
          { id: 'butterfly', name: 'Butterfly Hunter', icon: 'ğŸ¦‹', type: 'discovery', desc: 'See a butterfly' },
          { id: 'mushroom', name: 'Fungi Finder', icon: 'ğŸ„', type: 'discovery', desc: 'Discover mushrooms' },
          { id: 'wildflower', name: 'Flower Power', icon: 'ğŸŒ¸', type: 'discovery', desc: 'Find wildflowers' },
          { id: 'treeclimb', name: 'Tree Hugger', icon: 'ğŸŒ³', type: 'discovery', desc: 'Hug a big tree' },
          { id: 'pinecone', name: 'Pine Collector', icon: 'ğŸŒ²', type: 'discovery', desc: 'Collect a pinecone' },
          { id: 'rock', name: 'Rock Hound', icon: 'ğŸª¨', type: 'discovery', desc: 'Find a cool rock' },
          { id: 'feather', name: 'Feather Finder', icon: 'ğŸª¶', type: 'discovery', desc: 'Find a feather' },
          { id: 'stream', name: 'Stream Crosser', icon: 'ğŸŒŠ', type: 'discovery', desc: 'Cross a stream' },
          { id: 'cave', name: 'Cave Explorer', icon: 'ğŸ•³ï¸', type: 'discovery', desc: 'Explore a cave' },
          { id: 'bridge', name: 'Bridge Walker', icon: 'ğŸŒ‰', type: 'discovery', desc: 'Cross a bridge' },
          { id: 'sunset', name: 'Sunset Chaser', icon: 'ğŸŒ…', type: 'discovery', desc: 'Watch a sunset' },
          { id: 'sunrise', name: 'Early Bird', icon: 'ğŸŒ„', type: 'discovery', desc: 'Watch a sunrise' },
          { id: 'rainbow', name: 'Rainbow Finder', icon: 'ğŸŒˆ', type: 'discovery', desc: 'See a rainbow' },
          { id: 'fog', name: 'Mist Walker', icon: 'ğŸŒ«ï¸', type: 'discovery', desc: 'Hike in fog' },
          { id: 'snow', name: 'Snow Trekker', icon: 'â„ï¸', type: 'discovery', desc: 'Hike in snow' },
          { id: 'rain', name: 'Rain Ranger', icon: 'ğŸŒ§ï¸', type: 'discovery', desc: 'Hike in rain' },
          { id: 'frog', name: 'Frog Friend', icon: 'ğŸ¸', type: 'discovery', desc: 'See a frog or toad' },
          { id: 'squirrel', name: 'Squirrel Scout', icon: 'ğŸ¿ï¸', type: 'discovery', desc: 'Spot a squirrel' },
          { id: 'snake', name: 'Snake Spotter', icon: 'ğŸ', type: 'discovery', desc: 'See a snake safely' },
          { id: 'turtle', name: 'Turtle Tracker', icon: 'ğŸ¢', type: 'discovery', desc: 'Find a turtle' },
          { id: 'rabbit', name: 'Bunny Buddy', icon: 'ğŸ°', type: 'discovery', desc: 'Spot a rabbit' },
          { id: 'fish', name: 'Fish Finder', icon: 'ğŸŸ', type: 'discovery', desc: 'See fish in water' },
          { id: 'acorn', name: 'Acorn Collector', icon: 'ğŸŒ°', type: 'discovery', desc: 'Collect an acorn' },
          { id: 'leaf', name: 'Leaf Lover', icon: 'ğŸ‚', type: 'discovery', desc: 'Find a pretty leaf' },
          { id: 'stick', name: 'Walking Stick', icon: 'ğŸ¦¯', type: 'discovery', desc: 'Find a hiking stick' },
          { id: 'bee', name: 'Bee Keeper', icon: 'ğŸ', type: 'discovery', desc: 'See a bee or wasp' },
          { id: 'spider', name: 'Spider Scout', icon: 'ğŸ•·ï¸', type: 'discovery', desc: 'Find a spider web' },
          { id: 'tracks', name: 'Track Finder', icon: 'ğŸ¾', type: 'discovery', desc: 'Find animal tracks' },
          { id: 'berries', name: 'Berry Scout', icon: 'ğŸ«', type: 'discovery', desc: 'Find wild berries' },
          { id: 'nest', name: 'Nest Finder', icon: 'ğŸª¹', type: 'discovery', desc: 'Find a bird nest' },
          { id: 'fossil', name: 'Time Detective', icon: 'ğŸ¦´', type: 'discovery', desc: 'Find a fossil' },
          { id: 'crystal', name: 'Crystal Hunter', icon: 'ğŸ’', type: 'discovery', desc: 'Find crystals' },
          { id: 'clouds', name: 'Cloud Watcher', icon: 'â˜ï¸', type: 'discovery', desc: 'Watch the clouds' },
          { id: 'wind', name: 'Wind Rider', icon: 'ğŸ’¨', type: 'discovery', desc: 'Hike in strong wind' },
          { id: 'moon', name: 'Moon Gazer', icon: 'ğŸŒ™', type: 'discovery', desc: 'See the moon' },
          { id: 'beach', name: 'Beach Comber', icon: 'ğŸ–ï¸', type: 'location', desc: 'Hike at the beach' },
          { id: 'desert', name: 'Desert Wanderer', icon: 'ğŸœï¸', type: 'location', desc: 'Hike in the desert' },
          { id: 'forest', name: 'Forest Friend', icon: 'ğŸŒ²', type: 'location', desc: 'Hike in a forest' },
          { id: 'mountain', name: 'Mountain Master', icon: 'â›°ï¸', type: 'location', desc: 'Hike in mountains' },
          { id: 'canyon', name: 'Canyon Explorer', icon: 'ğŸï¸', type: 'location', desc: 'Hike in a canyon' },
          { id: 'lake', name: 'Lake Lover', icon: 'ğŸï¸', type: 'location', desc: 'Hike around a lake' },
          { id: 'river', name: 'River Runner', icon: 'ğŸï¸', type: 'location', desc: 'Hike along a river' },
          { id: 'statepark', name: 'Park Visitor', icon: 'ğŸ•ï¸', type: 'location', desc: 'Visit a state park' },
          { id: 'nationalpark', name: 'Park Ranger', icon: 'ğŸ–ï¸', type: 'location', desc: 'Visit a national park' },
          { id: 'meadow', name: 'Meadow Walker', icon: 'ğŸŒ¾', type: 'location', desc: 'Hike through a meadow' },
          { id: 'wetland', name: 'Wetland Explorer', icon: 'ğŸ¦†', type: 'location', desc: 'Visit a wetland or marsh' },
          { id: 'jungle', name: 'Jungle Trekker', icon: 'ğŸŒ´', type: 'location', desc: 'Hike in a jungle' },
          { id: 'prairie', name: 'Prairie Walker', icon: 'ğŸŒ»', type: 'location', desc: 'Hike on the prairie' },
          { id: 'tundra', name: 'Tundra Explorer', icon: 'ğŸ§Š', type: 'location', desc: 'Hike in tundra' },
          { id: 'volcano', name: 'Volcano Adventurer', icon: 'ğŸŒ‹', type: 'location', desc: 'Hike near a volcano' },
          { id: 'family', name: 'Family Time', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', type: 'special', desc: 'Whole family hikes together' },
          { id: 'picnic', name: 'Trail Feast', icon: 'ğŸ§º', type: 'special', desc: 'Have a trail picnic' },
          { id: 'camping', name: 'Happy Camper', icon: 'â›º', type: 'special', desc: 'Camp overnight' },
          { id: 'stargazing', name: 'Star Gazer', icon: 'â­', type: 'special', desc: 'Stargaze on trail' },
          { id: 'geocache', name: 'Treasure Hunter', icon: 'ğŸ’', type: 'special', desc: 'Find a geocache' },
          { id: 'summit', name: 'Summit Seeker', icon: 'ğŸ¯', type: 'special', desc: 'Reach a summit' },
          { id: 'lighthouse', name: 'Light Keeper', icon: 'ğŸ—¼', type: 'special', desc: 'Visit a lighthouse' },
          { id: 'historic', name: 'Time Traveler', icon: 'ğŸ›ï¸', type: 'special', desc: 'Visit historic site' },
          { id: 'photog', name: 'Photo Pro', icon: 'ğŸ“¸', type: 'special', desc: 'Take amazing photos' },
          { id: 'notrail', name: 'Off the Beaten Path', icon: 'ğŸ§­', type: 'special', desc: 'Hike off-trail' },
          { id: 'leader', name: 'Trail Leader', icon: 'ğŸ§‘â€ğŸ«', type: 'special', desc: 'Lead the group' },
          { id: 'map', name: 'Navigator', icon: 'ğŸ—ºï¸', type: 'special', desc: 'Use a map or compass' },
          { id: 'journal', name: 'Nature Writer', icon: 'ğŸ““', type: 'special', desc: 'Write in nature journal' },
          { id: 'art', name: 'Trail Artist', icon: 'ğŸ¨', type: 'special', desc: 'Draw or paint on trail' },
          { id: 'song', name: 'Trail Singer', icon: 'ğŸµ', type: 'special', desc: 'Sing hiking songs' },
          { id: 'story', name: 'Story Teller', icon: 'ğŸ“š', type: 'special', desc: 'Tell stories on trail' },
          { id: 'game', name: 'Trail Games', icon: 'ğŸ²', type: 'special', desc: 'Play trail games' },
          { id: 'clean', name: 'Trail Keeper', icon: 'â™»ï¸', type: 'special', desc: 'Pick up litter' },
          { id: 'help', name: 'Helpful Hiker', icon: 'ğŸ¤', type: 'special', desc: 'Help another hiker' },
          { id: 'courage', name: 'Brave Heart', icon: 'ğŸ’ª', type: 'special', desc: 'Overcome a fear' },
          { id: 'early', name: 'Morning Glory', icon: 'ğŸŒ', type: 'special', desc: 'Start before 7am' },
          { id: 'long', name: 'Endurance Pro', icon: 'â±ï¸', type: 'special', desc: 'Hike 4+ hours' },
          { id: 'quiet', name: 'Silent Steps', icon: 'ğŸ¤«', type: 'special', desc: 'Hike in silence' },
          { id: 'backwards', name: 'Backwards Walker', icon: 'ğŸ”„', type: 'special', desc: 'Walk backwards safely' },
          { id: 'barefoot', name: 'Nature Feet', icon: 'ğŸ¦¶', type: 'special', desc: 'Walk barefoot safely' },
          { id: 'night', name: 'Night Hiker', icon: 'ğŸŒƒ', type: 'special', desc: 'Hike at night' },
          { id: 'firstaid', name: 'Trail Medic', icon: 'ğŸ©¹', type: 'special', desc: 'Use first aid skills' },
          { id: 'fire', name: 'Fire Starter', icon: 'ğŸ”¥', type: 'special', desc: 'Build a safe fire' },
          { id: 'knots', name: 'Knot Master', icon: 'ğŸª¢', type: 'special', desc: 'Tie useful knots' },
          { id: 'binoculars', name: 'Far Seer', icon: 'ğŸ”­', type: 'special', desc: 'Use binoculars' },
          { id: 'whistle', name: 'Signal Master', icon: 'ğŸ“£', type: 'special', desc: 'Use safety whistle' },
          { id: 'fishing', name: 'Trail Fisher', icon: 'ğŸ£', type: 'special', desc: 'Fish on the trail' },
          { id: 'wade', name: 'Water Walker', icon: 'ğŸ‘£', type: 'special', desc: 'Wade through water' },
          { id: 'climb', name: 'Rock Climber', icon: 'ğŸ§—â€â™€ï¸', type: 'special', desc: 'Climb rocks safely' },
          { id: 'meditation', name: 'Trail Zen', icon: 'ğŸ§˜', type: 'special', desc: 'Meditate in nature' },
        ];

        function App() {
          const [user, setUser] = useState(null);
          const [familyId, setFamilyId] = useState(null);
          const [familyName, setFamilyName] = useState('');
          const [members, setMembers] = useState([]);
          const [currentMember, setCurrentMember] = useState(null);
          const [hikes, setHikes] = useState([]);
          const [loading, setLoading] = useState(true);
          const [showSetup, setShowSetup] = useState(false);
          const [setupStep, setSetupStep] = useState('family'); // 'family' or 'member'
          const [newFamilyName, setNewFamilyName] = useState('');
          const [joinCode, setJoinCode] = useState('');
          const [newMemberName, setNewMemberName] = useState('');
          const [newMemberAvatar, setNewMemberAvatar] = useState('ğŸ‘¦');
          const [newMemberColor, setNewMemberColor] = useState('#4CAF50');
          const [showMemberMenu, setShowMemberMenu] = useState(false);
          const [showForm, setShowForm] = useState(false);
          const [selectedBadge, setSelectedBadge] = useState(null);
          const [formData, setFormData] = useState({
            name: '',
            date: new Date().toISOString().split('T')[0],
            distance: '',
            elevation: '',
            location: '',
            notes: '',
            activities: []
          });

          useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(async (user) => {
              if (user) {
                setUser(user);
                const storedFamilyId = localStorage.getItem('familyId');
                const storedMemberId = localStorage.getItem('currentMemberId');
                
                if (storedFamilyId) {
                  await loadFamily(storedFamilyId, storedMemberId);
                } else {
                  setShowSetup(true);
                  setLoading(false);
                }
              } else {
                await auth.signInAnonymously();
              }
            });
            return unsubscribe;
          }, []);

          const loadFamily = async (famId, memberId) => {
            try {
              setFamilyId(famId);
              const familyDoc = await db.collection('families').doc(famId).get();
              if (familyDoc.exists) {
                setFamilyName(familyDoc.data().name);
              }

              const membersSnap = await db.collection('families').doc(famId).collection('members').get();
              const membersList = membersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setMembers(membersList);

              if (memberId && membersList.find(m => m.id === memberId)) {
                setCurrentMember(membersList.find(m => m.id === memberId));
              } else if (membersList.length > 0) {
                setCurrentMember(membersList[0]);
                localStorage.setItem('currentMemberId', membersList[0].id);
              }

              db.collection('families').doc(famId).collection('hikes').orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                  setHikes(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

              setLoading(false);
            } catch (error) {
              console.error('Error loading family:', error);
              setLoading(false);
            }
          };

          const createFamily = async () => {
            if (!newFamilyName.trim()) return;
            try {
              const familyRef = db.collection('families').doc();
              await familyRef.set({
                name: newFamilyName,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                ownerId: user.uid
              });
              localStorage.setItem('familyId', familyRef.id);
              setFamilyId(familyRef.id);
              setFamilyName(newFamilyName);
              setSetupStep('member');
            } catch (error) {
              alert('Error creating family: ' + error.message);
            }
          };

          const joinFamily = async () => {
            if (!joinCode.trim()) return;
            try {
              const familyDoc = await db.collection('families').doc(joinCode).get();
              if (familyDoc.exists) {
                localStorage.setItem('familyId', joinCode);
                await loadFamily(joinCode, null);
                setShowSetup(false);
              } else {
                alert('Family not found. Check the code and try again.');
              }
            } catch (error) {
              alert('Error joining family: ' + error.message);
            }
          };

          const createMember = async () => {
            if (!newMemberName.trim()) return;
            try {
              const memberRef = await db.collection('families').doc(familyId).collection('members').add({
                name: newMemberName,
                avatar: newMemberAvatar,
                color: newMemberColor,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              const newMember
